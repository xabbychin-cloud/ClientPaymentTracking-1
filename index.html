<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Client Payment Tracker</title>
<link rel="stylesheet" href="./style.css">
<style>
/* --- General Styles --- */
body {font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5;}
header {background-color:#4CAF50; padding:10px; color:white; display:flex; justify-content:space-between; align-items:center;}
header h1 {margin:0; font-size:1.5rem; color:white;}
header .toolbar button {margin-left:5px; padding:5px 10px; background:white; color:#4CAF50; border:none; cursor:pointer;}
header .toolbar button.active {background:#f1f1f1;}
#authContainer, #appContainer {padding:20px;}
.auth-form {max-width:400px; margin:30px auto; padding:20px; border:1px solid #ccc; border-radius:5px; background:white;}
.auth-form input, .auth-form select, .auth-form button {width:100%; margin-bottom:10px; padding:8px;}
.auth-form button {background:#4CAF50; color:white; border:none; cursor:pointer;}
.auth-form button:hover {background:#45a049;}
#logoutBtn {margin-top:20px; width:100%; padding:10px; background:#f44336; color:white; border:none; cursor:pointer;}
#logoutBtn:hover {background:#d32f2f;}

/* --- Forms --- */
.form-section {display:none; background:white; padding:15px; margin:15px 0; border-radius:5px; border:1px solid #ccc;}
.form-section h3 {margin-top:0;}
input, select, button {margin-bottom:10px; padding:8px; width:100%; box-sizing:border-box;}
.payables-table {max-height:150px; overflow-y:auto; border-collapse:collapse; width:100%;}
.payables-table th, .payables-table td {border:1px solid #ddd; padding:5px; text-align:left;}
.debit-red {color:red; font-weight:bold;}
.balance-red {color:red; font-weight:bold;}
.modal {display:none; position:fixed; z-index:1; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.5);}
.modal-content {background:white; margin:5% auto; padding:20px; border-radius:5px; width:90%; max-width:900px; max-height:80vh; overflow-y:auto;}
.close {color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;}
.close:hover {color:black;}
table {border-collapse:collapse; width:100%; margin-top:10px;}
th, td {border:1px solid #ddd; padding:8px; text-align:left;}
th {background:#f2f2f2;}
.report-section {background:white; padding:15px; border-radius:5px; border:1px solid #ccc; margin-top:15px;}
.report-section input {width:auto; display:inline-block;}
button.generate-report {background:#4CAF50; color:white; padding:5px 10px; border:none; cursor:pointer; margin-left:5px;}
@media(max-width:600px){header h1{font-size:1.2rem;} .auth-form, .form-section{margin:15px;}}
</style>
</head>
<body>

<header>
  <h1>Client Payment Tracker</h1>
  <div class="toolbar">
    <button id="btnCharge">Add Charge</button>
    <button id="btnPayment">Add Payment</button>
    <button id="btnExpenses">Expenses</button>
    <button id="btnAdmin">Admin Report</button>
  </div>
</header>

<div id="authContainer">
  <div id="signupForm" class="auth-form">
    <h2>Create Account</h2>
    <input id="signupEmail" type="email" placeholder="Email" required>
    <input id="signupPassword" type="password" placeholder="Password" required>
    <button id="signupBtn">Create Account</button>
    <p>Already have an account? <a href="#" id="showLogin">Login</a></p>
  </div>

  <div id="loginForm" class="auth-form" style="display:none;">
    <h2>Login</h2>
    <input id="loginEmail" type="email" placeholder="Email" required>
    <input id="loginPassword" type="password" placeholder="Password" required>
    <button id="loginBtn">Login</button>
    <p>Don't have an account? <a href="#" id="showSignup">Sign up</a></p>
  </div>
</div>

<div id="appContainer" style="display:none;">
  
  <!-- --- Add Charge --- -->
  <div id="sectionCharge" class="form-section">
    <h3>Add Charge</h3>
    <input id="chargeFirstName" placeholder="First Name" required>
    <input id="chargeLastName" placeholder="Last Name" required>
    <input id="chargeAmount" type="number" placeholder="Amount" required>
    <input id="chargeStartDate" type="date" required>
    <input id="chargeEndDate" type="date" required>
    <input id="chargeRemarks" placeholder="Remarks">
    <button id="addChargeBtn">Add Charge</button>
  </div>

  <!-- --- Add Payment --- -->
  <div id="sectionPayment" class="form-section">
    <h3>Add Payment</h3>
    <input id="paymentClientName" placeholder="Client Name" required>
    <div id="paymentBalance"></div>
    <table class="payables-table" id="unpaidChargesTable">
      <thead><tr><th>Date</th><th>Amount</th><th>Remarks</th></tr></thead>
      <tbody></tbody>
    </table>
    <input id="paymentAmount" type="number" placeholder="Payment Amount" required>
    <input id="paymentDate" type="date" required>
    <select id="paymentType">
      <option value="">Select Payment Type</option>
      <option value="cash">Cash</option>
      <option value="bank transfer">Bank Transfer</option>
      <option value="credit card">Credit Card</option>
      <option value="others">Others</option>
    </select>
    <select id="paymentMode">
      <option value="">Select Payment Mode</option>
      <option value="full">Full Payment</option>
      <option value="partial">Partial Payment</option>
    </select>
    <input id="paymentRemarks" placeholder="Remarks">
    <button id="addPaymentBtn">Add Payment</button>
  </div>

  <!-- --- Expenses --- -->
  <div id="sectionExpenses" class="form-section">
    <h3>Add Expense</h3>
    <input id="expenseDate" type="date" required>
    <input id="expenseAmount" type="number" placeholder="Amount" required>
    <input id="expenseDescription" placeholder="Description" required>
    <input id="expenseInvoice" placeholder="Invoice #">
    <button id="addExpenseBtn">Add Expense</button>
  </div>

  <!-- --- Admin Report --- -->
  <div id="sectionAdmin" class="form-section report-section">
    <h3>Admin Report</h3>
    Start: <input type="date" id="reportStart"> End: <input type="date" id="reportEnd">
    <button class="generate-report" id="generateReportBtn">Generate</button>
    <div id="reportSummary"></div>
  </div>

  <button id="logoutBtn">Logout</button>
</div>

<!-- --- Client Records Modal --- -->
<div id="viewModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <h2 id="modalTitle">Client Records</h2>
    <div id="modalSummary">
      <p><strong>Total Debit:</strong> <span id="totalDebit"></span></p>
      <p><strong>Total Credit:</strong> <span id="totalCredit"></span></p>
      <p><strong>Balance:</strong> <span id="balance" class="balance-red"></span></p>
      <p><strong>Status:</strong> <span id="status"></span></p>
    </div>
    <h3>Transaction History</h3>
    <table class="history-table" id="historyTable">
      <thead>
        <tr><th>Date</th><th>Debit</th><th>Credit</th><th>Method</th><th>Mode</th><th>Remarks</th><th>Start</th><th>End</th></tr>
      </thead>
      <tbody id="historyBody"></tbody>
    </table>
  </div>
</div>

<script type="module">
// ---------- Firebase Imports ----------
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, addDoc, onSnapshot, query, where, getDocs, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCrtGcFZVwP6dlsc_Bljr_yN-nu6hxihVg",
  authDomain: "client-payment-tracker-3572b.firebaseapp.com",
  projectId: "client-payment-tracker-3572b",
  storageBucket: "client-payment-tracker-3572b.firebasestorage.app",
  messagingSenderId: "151091330895",
  appId: "1:151091330895:web:d23440ad57a386da720f3a",
  measurementId: "G-NH7D18261Q"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
enableIndexedDbPersistence(db).catch(e=>console.warn(e));

let currentUser=null;
let clients={};
let expenses=[];

// --- Auth Functions ---
function showAuth(){document.getElementById("authContainer").style.display="block"; document.getElementById("appContainer").style.display="none";}
function showApp(){document.getElementById("authContainer").style.display="none"; document.getElementById("appContainer").style.display="block"; loadClients(); loadExpenses();}

// Signup
document.getElementById("signupBtn").addEventListener("click", async ()=>{
  try{
    await createUserWithEmailAndPassword(auth, document.getElementById("signupEmail").value, document.getElementById("signupPassword").value);
    alert("Account created!");
  }catch(err){alert("Signup failed: "+err.message);}
});

// Login
document.getElementById("loginBtn").addEventListener("click", async ()=>{
  try{
    await signInWithEmailAndPassword(auth, document.getElementById("loginEmail").value, document.getElementById("loginPassword").value);
  }catch(err){alert("Login failed: "+err.message);}
});

document.getElementById("showLogin").addEventListener("click", e=>{e.preventDefault(); document.getElementById("signupForm").style.display="none"; document.getElementById("loginForm").style.display="block";});
document.getElementById("showSignup").addEventListener("click", e=>{e.preventDefault(); document.getElementById("loginForm").style.display="none"; document.getElementById("signupForm").style.display="block";});

// Logout
document.getElementById("logoutBtn").addEventListener("click", async ()=>{await signOut(auth);});

// Auth State
onAuthStateChanged(auth, user=>{
  if(user){currentUser=user; showApp();}
  else{currentUser=null; showAuth();}
});

// --- Toolbar Events ---
const sections=["sectionCharge","sectionPayment","sectionExpenses","sectionAdmin"];
sections.forEach(s=>document.getElementById("btn"+s.replace("section","")).addEventListener("click", ()=>{
  sections.forEach(sec=>document.getElementById(sec).style.display="none");
  document.getElementById(s).style.display="block";
}));

// --- Helper: generate client ID ---
function generateClientId(first,last){return `${first}_${last}`.replace(/\s+/g,"_").toLowerCase();}

// --- Load Clients ---
function loadClients(){
  if(!currentUser) return;
  onSnapshot(collection(db,"users",currentUser.uid,"clients"), snap=>{
    clients={};
    snap.forEach(d=>clients[d.id]=d.data());
  });
}

// --- Load Expenses ---
function loadExpenses(){
  if(!currentUser) return;
  onSnapshot(collection(db,"users",currentUser.uid,"expenses"), snap=>{
    expenses=[];
    snap.forEach(d=>expenses.push(d.data()));
  });
}

// --- Add Charge ---
document.getElementById("addChargeBtn").addEventListener("click", async ()=>{
  const first=document.getElementById("chargeFirstName").value;
  const last=document.getElementById("chargeLastName").value;
  const amount=parseFloat(document.getElementById("chargeAmount").value);
  const start=document.getElementById("chargeStartDate").value;
  const end=document.getElementById("chargeEndDate").value;
  const remarks=document.getElementById("chargeRemarks").value;
  const id=generateClientId(first,last);
  const ref=doc(db,"users",currentUser.uid,"clients",id);
  const snap=await getDoc(ref);
  const c=snap.exists()?snap.data():{firstName:first,lastName:last,debit:0,credit:0,history:[]};
  c.history.push({date:new Date().toLocaleString(),debit:amount,credit:0,method:"charge",paymentMode:"",remarks,startDate:start,endDate:end});
  await setDoc(ref,{firstName:first,lastName:last,debit:(c.debit||0)+amount,credit:c.credit||0,history:c.history},{merge:true});
  alert("Charge added!");
});

// --- Add Payment ---
document.getElementById("addPaymentBtn").addEventListener("click", async ()=>{
  const fullName=document.getElementById("paymentClientName").value.trim();
  const amount=parseFloat(document.getElementById("paymentAmount").value);
  const date=document.getElementById("paymentDate").value;
  const type=document.getElementById("paymentType").value;
  const mode=document.getElementById("paymentMode").value;
  const remarks=document.getElementById("paymentRemarks").value;
  if(!fullName) return alert("Enter client name");
  const [first,last]=fullName.split(" ");
  const id=generateClientId(first,last);
  const ref=doc(db,"users",currentUser.uid,"clients",id);
  const snap=await getDoc(ref);
  const c=snap.exists()?snap.data():{firstName:first,lastName:last,debit:0,credit:0,history:[]};
  c.history.push({date, debit:0, credit:amount, method:type, paymentMode:mode, remarks});
  await setDoc(ref,{firstName:first,lastName:last,debit:c.debit||0,credit:(c.credit||0)+amount,history:c.history},{merge:true});
  alert("Payment added!");
});

// --- Populate payables on client select ---
document.getElementById("paymentClientName").addEventListener("input", ()=>{
  const name=document.getElementById("paymentClientName").value.trim().toLowerCase();
  const tbody=document.querySelector("#unpaidChargesTable tbody");
  tbody.innerHTML="";
  const client=Object.values(clients).find(c=>`${c.firstName} ${c.lastName}`.toLowerCase()===name);
  if(client){
    const balance=(client.debit||0)-(client.credit||0);
    document.getElementById("paymentBalance").textContent="Outstanding Balance: "+balance.toFixed(2);
    document.getElementById("paymentBalance").style.color=balance>0?"red":"black";
    (client.history||[]).forEach(h=>{
      const bal=(h.debit||0)-(h.credit||0);
      if(bal>0){
        const row=document.createElement("tr");
        row.innerHTML=`<td>${h.date}</td><td class="debit-red">${bal.toFixed(2)}</td><td>${h.remarks||""}</td>`;
        row.addEventListener("click", ()=>{document.getElementById("paymentAmount").value=bal.toFixed(2);});
        tbody.appendChild(row);
      }
    });
  }else{
    document.getElementById("paymentBalance").textContent="";
  }
});

// --- Add Expense ---
document.getElementById("addExpenseBtn").addEventListener("click", async ()=>{
  const date=document.getElementById("expenseDate").value;
  const amount=parseFloat(document.getElementById("expenseAmount").value);
  const description=document.getElementById("expenseDescription").value;
  const invoice=document.getElementById("expenseInvoice").value;
  await addDoc(collection(db,"users",currentUser.uid,"expenses"),{date,amount,description,invoice});
  alert("âœ… Expense successfully added!");
});

// --- Admin Report ---
document.getElementById("generateReportBtn").addEventListener("click", ()=>{
  const start=document.getElementById("reportStart").value?new Date(document.getElementById("reportStart").value):null;
  const end=document.getElementById("reportEnd").value?new Date(document.getElementById("reportEnd").value):null;
  let totalSales=0, totalExpenses=0;
  Object.values(clients).forEach(c=>{
    (c.history||[]).forEach(h=>{
      const d=new Date(h.date);
      if((!start||d>=start)&&(!end||d<=end)){
        if(h.method==="payment") totalSales+=h.credit||0;
      }
    });
  });
  expenses.forEach(e=>{
    const d=new Date(e.date);
    if(!start||d>=start) if(!end||d<=end) totalExpenses+=e.amount||0;
  });
  document.getElementById("reportSummary").innerHTML=`<p>Total Sales: ${totalSales.toFixed(2)}</p><p>Total Expenses: ${totalExpenses.toFixed(2)}</p><p>Net Income: ${(totalSales-totalExpenses).toFixed(2)}</p>`;
});

// --- View Modal ---
const modal=document.getElementById("viewModal");
document.getElementById("closeModal").addEventListener("click", ()=>{modal.style.display="none";});
window.viewClient=function(id){
  const c=clients[id];
  if(!c) return;
  document.getElementById("modalTitle").textContent=c.firstName+" "+c.lastName;
  document.getElementById("totalDebit").textContent=(c.debit||0).toFixed(2);
  document.getElementById("totalCredit").textContent=(c.credit||0).toFixed(2);
  const balance=(c.debit||0)-(c.credit||0);
  document.getElementById("balance").textContent=balance.toFixed(2);
  document.getElementById("status").textContent=balance>0?"Outstanding":"Paid";
  const tbody=document.getElementById("historyBody");
  tbody.innerHTML="";
  (c.history||[]).forEach(h=>{
    const bal=(h.debit||0)-(h.credit||0);
    tbody.insertAdjacentHTML("beforeend",`<tr>
      <td>${h.date||""}</td>
      <td class="${bal>0?'debit-red':''}">${(h.debit||0).toFixed(2)}</td>
      <td>${(h.credit||0).toFixed(2)}</td>
      <td>${h.method||""}</td>
      <td>${h.paymentMode||""}</td>
      <td>${h.remarks||""}</td>
      <td>${h.startDate||""}</td>
      <td>${h.endDate||""}</td>
    </tr>`);
  });
  modal.style.display='block';
};
</script>

</body>
</html>
