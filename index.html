<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Client Payment Tracker</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 20px; }
    form { margin-bottom: 16px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; }
    h3 { margin: 0 0 10px; }
    input, select, button { margin: 4px; padding: 8px; }
    table { width: 100%; border-collapse: collapse; margin: 14px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    .filters, .search-bar { margin: 10px 0; }
    .status-outstanding { background: #fff8e6; }
    .status-paid { background: #eef9f1; }
  </style>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ðŸ”‘ Your Firebase config (paste yours here)
    const firebaseConfig = {
      apiKey: "AIzaSyCrtGcFZVwP6dlsc_Bljr_yN-nu6hxihVg",
      authDomain: "client-payment-tracker-3572b.firebaseapp.com",
      projectId: "client-payment-tracker-3572b",
      storageBucket: "client-payment-tracker-3572b.appspot.com",
      messagingSenderId: "151091330895",
      appId: "1:151091330895:web:d23440ad57a386da720f3a",
      measurementId: "G-NH7D18261Q"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---------- State ----------
    let clients = {};
    let currentFilter = 'all';

    // ---------- Helpers ----------
    function computeBalance(c){ return (Number(c.debit)||0) - (Number(c.credit)||0); }

    async function ensureClient(id, firstName='', lastName='') {
      const ref = doc(db, "clients", id);
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, { firstName, lastName, debit: 0, credit: 0, history: [] });
      } else {
        const data = snap.data();
        const updates = {};
        if (firstName && firstName !== data.firstName) updates.firstName = firstName;
        if (lastName && lastName !== data.lastName) updates.lastName = lastName;
        if (Object.keys(updates).length) await updateDoc(ref, updates);
      }
    }

    async function addCharge(id, firstName, lastName, amount, remarks) {
      if (!id || isNaN(amount) || amount <= 0) { alert('Invalid charge'); return; }
      await ensureClient(id, firstName, lastName);
      const ref = doc(db, "clients", id);
      const snap = await getDoc(ref);
      const c = snap.data();
      const newHistory = [...(c.history||[]), {
        date: new Date().toLocaleString(),
        debit: amount, credit: 0, method: 'charge', remarks: remarks||''
      }];
      await updateDoc(ref, {
        debit: (c.debit||0) + amount,
        history: newHistory
      });
      alert(`Charge added successfully for ${c.firstName||firstName||''} ${c.lastName||lastName||''} (ID: ${id})`);
    }

    async function addPayment(id, firstName, lastName, amount, method, remarks) {
      if (!id || !firstName || !lastName || isNaN(amount) || amount <= 0) { alert('Invalid payment'); return; }
      await ensureClient(id, firstName, lastName);
      const ref = doc(db, "clients", id);
      const snap = await getDoc(ref);
      const c = snap.data();
      const newHistory = [...(c.history||[]), {
        date: new Date().toLocaleString(),
        debit: 0, credit: amount, method: method||'cash', remarks: remarks||''
      }];
      await updateDoc(ref, {
        firstName, lastName,
        credit: (c.credit||0) + amount,
        history: newHistory
      });
      alert(`Payment added successfully for ${firstName} ${lastName} (ID: ${id})`);
    }

    // ---------- Rendering ----------
    function renderSummary() {
      const tbody = document.querySelector('#clientsTable tbody');
      tbody.innerHTML = '';
      Object.keys(clients).forEach(id => {
        const c = clients[id];
        const balance = computeBalance(c);
        const status = balance > 0 ? 'Outstanding' : 'Paid';
        if (currentFilter !== 'all' && status.toLowerCase() !== currentFilter) return;
        let lastDate='', lastRemarks='';
        if (c.history && c.history.length>0) {
          const last=c.history[c.history.length-1];
          lastDate=last.date; lastRemarks=last.remarks||'';
        }
        tbody.insertAdjacentHTML('beforeend',`
          <tr class="${status==='Outstanding'?'status-outstanding':'status-paid'}">
            <td>${id}</td>
            <td>${c.firstName||''} ${c.lastName||''}</td>
            <td>${(c.debit||0).toFixed(2)}</td>
            <td>${(c.credit||0).toFixed(2)}</td>
            <td>${balance.toFixed(2)}</td>
            <td>${status}</td>
            <td>${lastDate}</td>
            <td>${lastRemarks}</td>
          </tr>
        `);
      });
    }

    function populateHistory(matches){
      const tbody=document.querySelector('#historyTable tbody');
      tbody.innerHTML='';
      matches.forEach(({id,client})=>{
        if(!client.history||client.history.length===0){
          tbody.insertAdjacentHTML('beforeend',`
            <tr><td>${id}</td><td>${client.firstName||''} ${client.lastName||''}</td>
            <td colspan="5" style="text-align:center;">No transactions recorded yet</td></tr>`);
        } else {
          client.history.forEach(p=>{
            tbody.insertAdjacentHTML('beforeend',`
              <tr>
                <td>${id}</td>
                <td>${client.firstName||''} ${client.lastName||''}</td>
                <td>${p.date}</td>
                <td>${(p.debit||0).toFixed(2)}</td>
                <td>${(p.credit||0).toFixed(2)}</td>
                <td>${p.method||''}</td>
                <td>${p.remarks||''}</td>
              </tr>
            `);
          });
        }
      });
    }

    function viewClientRecord(term){
      const t=(term||'').trim();
      if(!t){alert('Enter a client ID, first name, or surname.');return;}
      const lower=t.toLowerCase();
      const matches=Object.keys(clients)
        .filter(id=>id.toLowerCase()===lower||
          (clients[id].firstName||'').toLowerCase().includes(lower)||
          (clients[id].lastName||'').toLowerCase().includes(lower))
        .map(id=>({id,client:clients[id]}));
      if(matches.length===0){alert('No matching client found.');return;}
      populateHistory(matches);
    }

    // ---------- Real-time sync ----------
    onSnapshot(collection(db,"clients"),(snap)=>{
      clients={};
      snap.forEach(docSnap=>{
        clients[docSnap.id]=docSnap.data();
      });
      renderSummary();
    });

    // ---------- Wire UI ----------
    window.addEventListener('DOMContentLoaded',()=>{
      document.getElementById('filterAll').addEventListener('click',()=>{currentFilter='all';renderSummary();});
      document.getElementById('filterOutstanding').addEventListener('click',()=>{currentFilter='outstanding';renderSummary();});
      document.getElementById('filterPaid').addEventListener('click',()=>{currentFilter='paid';renderSummary();});
      document.getElementById('searchBtn').addEventListener('click',()=>viewClientRecord(document.getElementById('searchInput').value));
      document.getElementById('viewAllBtn').addEventListener('click',()=>{
        const matches=Object.keys(clients).map(id=>({id,client:clients[id]}));
        populateHistory(matches);
      });
      document.getElementById('chargeForm').addEventListener('submit',async(e
