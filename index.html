<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Client Payment Tracker</title>

<style>
body{margin:0;font-family:Arial;background:#f4f4f4}
h1{background:#2e7d32;color:white;padding:15px;text-align:center;margin:0}

#toolbar{display:flex;gap:8px;padding:10px;background:#333;overflow-x:auto}
#toolbar button{background:#4CAF50;color:white;border:none;padding:10px 14px;border-radius:4px;cursor:pointer}

.section{display:none;background:white;margin:10px;padding:15px;border-radius:6px}
input,select,button{width:100%;padding:8px;margin-top:6px}

table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px}
th{background:#eee;color:black}

.highlight{background:yellow;font-weight:bold}
.balance-red{color:red;font-weight:bold}
.balance-black{color:black}

.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5)}
.modal-content{background:white;width:95%;max-width:900px;margin:5% auto;padding:15px;max-height:80vh;overflow:auto}

.autocomplete-box{position:relative}
.autocomplete-list{position:absolute;background:white;border:1px solid #ccc;width:100%;max-height:150px;overflow:auto;z-index:10}
.autocomplete-item{padding:6px;cursor:pointer}
.autocomplete-item:hover{background:#eee}

.unpaid-row{background:#ffe6e6}

#logoutBtn{background:#c62828;color:white;margin:15px}
</style>
</head>

<body>

<h1>Client Payment Tracker</h1>

<div id="toolbar">
  <button onclick="showSection('clientSection')">Clients</button>
  <button onclick="showSection('chargeSection')">Add Charge</button>
  <button onclick="showSection('paymentSection')">Add Payment</button>
  <button onclick="showSection('expenseSection')">Expenses</button>
  <button onclick="showSection('reportSection')">Admin Report</button>
</div>

<!-- LOGIN -->
<div id="authSection" class="section" style="display:block">
  <h3>Login</h3>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPassword" type="password">
  <button id="loginBtn">Login</button>
</div>

<div id="appSection" style="display:none">

<!-- CLIENTS -->
<div id="clientSection" class="section">
  <input id="clientSearchInput" placeholder="Search client">
  <button id="clientSearchBtn">Search</button>
  <select id="clientFilter">
    <option value="all">All</option>
    <option value="outstanding">Outstanding</option>
    <option value="paid">Paid</option>
  </select>

  <table>
    <thead>
      <tr><th>Name</th><th>Debit</th><th>Credit</th><th>Balance</th><th>Status</th><th></th></tr>
    </thead>
    <tbody id="clientsBody"></tbody>
  </table>
</div>

<!-- ADD CHARGE -->
<div id="chargeSection" class="section">
  <div class="autocomplete-box">
    <input id="chargeName" placeholder="Client Full Name">
    <div id="chargeAuto" class="autocomplete-list"></div>
  </div>
  <input id="chargeAmount" type="number" placeholder="Amount">
  <input id="chargeStart" type="date">
  <input id="chargeEnd" type="date">
  <input id="chargeRemarks" placeholder="Remarks">
  <button id="addChargeBtn">Save Charge</button>
</div>

<!-- ADD PAYMENT -->
<div id="paymentSection" class="section">
  <div class="autocomplete-box">
    <input id="paymentSearch" placeholder="Search client">
    <div id="paymentAuto" class="autocomplete-list"></div>
  </div>

  <div id="paymentBalance"></div>

  <input id="paymentAmount" type="number" placeholder="Payment Amount">
  <select id="paymentType">
    <option value="">Payment Type</option>
    <option>Cash</option>
    <option>Bank Transfer</option>
    <option>Credit Card</option>
    <option>Others</option>
  </select>
  <select id="paymentMode">
    <option value="">Payment Mode</option>
    <option>Full</option>
    <option>Partial</option>
  </select>
  <input id="paymentDate" type="date">
  <input id="paymentRemarks" placeholder="Remarks">
  <button id="addPaymentBtn">Save Payment</button>
</div>

<!-- EXPENSE -->
<div id="expenseSection" class="section">
  <h4>Add Expense</h4>
  <input id="expenseDate" type="date">
  <input id="expenseAmount" type="number" placeholder="Amount">
  <input id="expenseDesc" placeholder="Description">
  <button id="addExpenseBtn">Save Expense</button>

  <h4>View Expenses</h4>
  <input id="expenseStart" type="date">
  <input id="expenseEnd" type="date">
  <button id="filterExpensesBtn">View Expenses</button>

  <table>
    <thead><tr><th>Date</th><th>Amount</th><th>Description</th></tr></thead>
    <tbody id="expensesBody"></tbody>
  </table>
</div>

<!-- REPORT -->
<div id="reportSection" class="section">
  <input id="reportStart" type="date">
  <input id="reportEnd" type="date">
  <button id="generateReportBtn">Generate Report</button>
  <div id="reportResult"></div>
</div>

<button id="logoutBtn">Logout</button>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {getAuth,signInWithEmailAndPassword,onAuthStateChanged,signOut} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {getFirestore,doc,setDoc,getDoc,collection,onSnapshot,addDoc} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const app=initializeApp({
  apiKey:"AIzaSyCrtGcFZVwP6dlsc_Bljr_yN-nu6hxihVg",
  authDomain:"client-payment-tracker-3572b.firebaseapp.com",
  projectId:"client-payment-tracker-3572b"
});

const auth=getAuth(app), db=getFirestore(app);
let currentUser=null, clients={}, expenses=[];
const cid=n=>n.toLowerCase().replace(/\s+/g,'_');

loginBtn.onclick=()=>signInWithEmailAndPassword(auth,loginEmail.value,loginPassword.value)
.catch(e=>alert(e.message));

onAuthStateChanged(auth,u=>{
  if(u){
    currentUser=u;
    authSection.style.display="none";
    appSection.style.display="block";
    loadClients(); loadExpenses();
  }
});

logoutBtn.onclick = async () => {
  try {
    await signOut(auth);

    // Force UI reset
    currentUser = null;
    appSection.style.display = "none";
    authSection.style.display = "block";

    // Clear sensitive fields
    loginEmail.value = "";
    loginPassword.value = "";

  } catch (e) {
    alert("Logout failed: " + e.message);
  }
};


// LOAD CLIENTS
function loadClients(){
  onSnapshot(collection(db,"users",currentUser.uid,"clients"),s=>{
    clients={}; s.forEach(d=>clients[d.id]=d.data());
    renderClients();
  });
}

// CLIENT SEARCH
function renderClients(){
  const q=clientSearchInput.value.toLowerCase();
  const f=clientFilter.value;
  clientsBody.innerHTML="";
  Object.values(clients).forEach(c=>{
    const bal=(c.debit||0)-(c.credit||0);
    const status=bal>0?"outstanding":"paid";
    if(q&&!c.name.toLowerCase().includes(q))return;
    if(f!=="all"&&f!==status)return;
    clientsBody.innerHTML+=`
    <tr>
      <td>${q?c.name.replace(new RegExp(q,"gi"),m=>`<span class="highlight">${m}</span>`):c.name}</td>
      <td>${c.debit||0}</td>
      <td>${c.credit||0}</td>
      <td class="${bal>0?'balance-red':'balance-black'}">${bal}</td>
      <td>${status}</td>
      <td><button onclick="viewClient('${c.name}')">View</button></td>
    </tr>`;
  });
}

clientSearchBtn.onclick=renderClients;
clientFilter.onchange=renderClients;

// AUTOCOMPLETE – ADD CHARGE
chargeName.oninput=()=>{
  chargeAuto.innerHTML="";
  const q=chargeName.value.toLowerCase();
  Object.values(clients).forEach(c=>{
    if(c.name.toLowerCase().includes(q)){
      const d=document.createElement("div");
      d.className="autocomplete-item";
      d.textContent=c.name;
      d.onclick=()=>{chargeName.value=c.name;chargeAuto.innerHTML="";}
      chargeAuto.appendChild(d);
    }
  });
};

// ADD CHARGE
addChargeBtn.onclick=async()=>{
  if(!chargeName.value||!chargeAmount.value)return alert("Missing data");
  const ref=doc(db,"users",currentUser.uid,"clients",cid(chargeName.value));
  const s=await getDoc(ref);
  const c=s.exists()?s.data():{name:chargeName.value,debit:0,credit:0,history:[]};
  c.history.push({
    date:new Date().toISOString(),
    debit:+chargeAmount.value,
    credit:0,
    remarks:chargeRemarks.value,
    start:chargeStart.value,
    end:chargeEnd.value
  });
  await setDoc(ref,{...c,debit:c.debit+ +chargeAmount.value});
  alert("Charge saved");
  chargeName.value=chargeAmount.value=chargeStart.value=chargeEnd.value=chargeRemarks.value="";
};

// AUTOCOMPLETE – PAYMENT
paymentSearch.oninput=()=>{
  paymentAuto.innerHTML="";
  const q=paymentSearch.value.toLowerCase();
  Object.values(clients).forEach(c=>{
    if(c.name.toLowerCase().includes(q)){
      const d=document.createElement("div");
      d.className="autocomplete-item";
      d.textContent=c.name;
      d.onclick=()=>{
        paymentSearch.value=c.name;
        const bal=(c.debit||0)-(c.credit||0);
        paymentBalance.innerHTML=`Balance: <span class="${bal>0?'balance-red':'balance-black'}">${bal}</span>`;
        paymentAuto.innerHTML="";
      };
      paymentAuto.appendChild(d);
    }
  });
};

// ADD PAYMENT (CLEARS INPUTS)
addPaymentBtn.onclick=async()=>{
  const ref=doc(db,"users",currentUser.uid,"clients",cid(paymentSearch.value));
  const s=await getDoc(ref);
  const c=s.data();
  c.history.push({
    date:paymentDate.value,
    debit:0,
    credit:+paymentAmount.value,
    type:paymentType.value,
    mode:paymentMode.value,
    remarks:paymentRemarks.value
  });
  await setDoc(ref,{...c,credit:c.credit+ +paymentAmount.value});
  alert("Payment saved");
  paymentSearch.value=paymentAmount.value=paymentDate.value=paymentRemarks.value="";
  paymentType.value=paymentMode.value="";
  paymentBalance.innerHTML="";
};

// EXPENSES
function loadExpenses(){
  onSnapshot(collection(db,"users",currentUser.uid,"expenses"),s=>{
    expenses=[]; s.forEach(d=>expenses.push(d.data()));
  });
}

addExpenseBtn.onclick=async()=>{
  await addDoc(collection(db,"users",currentUser.uid,"expenses"),{
    date:expenseDate.value,amount:+expenseAmount.value,desc:expenseDesc.value
  });
  alert("Expense saved");
  expenseDate.value=expenseAmount.value=expenseDesc.value="";
};

filterExpensesBtn.onclick=()=>{
  const s=new Date(expenseStart.value), e=new Date(expenseEnd.value);
  expensesBody.innerHTML="";
  expenses.filter(x=>new Date(x.date)>=s&&new Date(x.date)<=e)
    .forEach(x=>{
      expensesBody.innerHTML+=`<tr><td>${x.date}</td><td>${x.amount}</td><td>${x.desc}</td></tr>`;
    });
};

window.showSection=id=>{
  document.querySelectorAll(".section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
};
</script>
</body>
</html>

