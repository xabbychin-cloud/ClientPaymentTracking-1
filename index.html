<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    onSnapshot,
    collection
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCrtGcFZVwP6dlsc_Bljr_yN-nu6hxihVg",
    authDomain: "client-payment-tracker-3572b.firebaseapp.com",
    projectId: "client-payment-tracker-3572b",
    storageBucket: "client-payment-tracker-3572b.firebasestorage.app",
    messagingSenderId: "151091330895",
    appId: "1:151091330895:web:d23440ad57a386da720f3a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // üîó DOM REFERENCES (REQUIRED)
  const chargeForm = document.getElementById("chargeForm");
  const paymentForm = document.getElementById("paymentForm");
  const filterAll = document.getElementById("filterAll");
  const filterOutstanding = document.getElementById("filterOutstanding");
  const filterPaid = document.getElementById("filterPaid");
  const searchBtn = document.getElementById("searchBtn");
  const viewAllBtn = document.getElementById("viewAllBtn");
  const searchInput = document.getElementById("searchInput");

  let clients = {};
  let currentFilter = "all";

  const balanceOf = c => (c.debit || 0) - (c.credit || 0);

  async function addCharge(id, first, last, amount, remarks) {
    const ref = doc(db, "clients", id);
    const snap = await getDoc(ref);
    const c = snap.exists()
      ? snap.data()
      : { firstName: first, lastName: last, debit: 0, credit: 0, history: [] };

    c.history.push({
      date: new Date().toLocaleString(),
      debit: amount,
      credit: 0,
      method: "charge",
      remarks
    });

    await setDoc(ref, {
      ...c,
      firstName: first,
      lastName: last,
      debit: (c.debit || 0) + amount
    });

    alert("Charge added");
  }

  async function addPayment(id, first, last, amount, method, remarks) {
    const ref = doc(db, "clients", id);
    const snap = await getDoc(ref);
    const c = snap.exists()
      ? snap.data()
      : { firstName: first, lastName: last, debit: 0, credit: 0, history: [] };

    c.history.push({
      date: new Date().toLocaleString(),
      debit: 0,
      credit: amount,
      method,
      remarks
    });

    await setDoc(ref, {
      ...c,
      firstName: first,
      lastName: last,
      credit: (c.credit || 0) + amount
    });

    alert("Payment added");
  }

  onSnapshot(collection(db, "clients"), snap => {
    clients = {};
    snap.forEach(d => (clients[d.id] = d.data()));
    renderClients();
  });

  function renderClients() {
    const tbody = document.querySelector("#clientsTable tbody");
    tbody.innerHTML = "";

    Object.entries(clients).forEach(([id, c]) => {
      const balance = balanceOf(c);
      const status = balance > 0 ? "Outstanding" : "Paid";
      if (currentFilter !== "all" && status.toLowerCase() !== currentFilter) return;

      const last = c.history?.[c.history.length - 1] || {};

      tbody.insertAdjacentHTML(
        "beforeend",
        `
        <tr>
          <td>${id}</td>
          <td>${c.firstName || ""} ${c.lastName || ""}</td>
          <td>${(c.debit || 0).toFixed(2)}</td>
          <td>${(c.credit || 0).toFixed(2)}</td>
          <td>${balance.toFixed(2)}</td>
          <td>${status}</td>
          <td>${last.date || ""}</td>
          <td>${last.remarks || ""}</td>
        </tr>
      `
      );
    });
  }

  function renderHistory(list) {
    const tbody = document.querySelector("#historyTable tbody");
    tbody.innerHTML = "";

    list.forEach(({ id, client }) => {
      client.history.forEach(h => {
        tbody.insertAdjacentHTML(
          "beforeend",
          `
          <tr>
            <td>${id}</td>
            <td>${client.firstName} ${client.lastName}</td>
            <td>${h.date}</td>
            <td>${h.debit.toFixed(2)}</td>
            <td>${h.credit.toFixed(2)}</td>
            <td>${h.method}</td>
            <td>${h.remarks || ""}</td>
          </tr>
        `
        );
      });
    });
  }

  // üßæ EVENTS
  chargeForm.addEventListener("submit", e => {
    e.preventDefault();
    addCharge(
      document.getElementById("chargeClientId").value,
      document.getElementById("chargeFirstName").value,
      document.getElementById("chargeLastName").value,
      parseFloat(document.getElementById("chargeAmount").value),
      document.getElementById("chargeRemarks").value
    );
    chargeForm.reset();
  });

  paymentForm.addEventListener("submit", e => {
    e.preventDefault();
    addPayment(
      document.getElementById("clientId").value,
      document.getElementById("firstName").value,
      document.getElementById("lastName").value,
      parseFloat(document.getElementById("amount").value),
      document.getElementById("method").value,
      document.getElementById("remarks").value
    );
    paymentForm.reset();
  });

  filterAll.onclick = () => { currentFilter = "all"; renderClients(); };
  filterOutstanding.onclick = () => { currentFilter = "outstanding"; renderClients(); };
  filterPaid.onclick = () => { currentFilter = "paid"; renderClients(); };

  searchBtn.onclick = () => {
    const term = searchInput.value.toLowerCase();
    renderHistory(
      Object.entries(clients)
        .filter(([id, c]) =>
          id.toLowerCase().includes(term) ||
          c.firstName?.toLowerCase().includes(term) ||
          c.lastName?.toLowerCase().includes(term)
        )
        .map(([id, client]) => ({ id, client }))
    );
  };

  viewAllBtn.onclick = () => {
    renderHistory(Object.entries(clients).map(([id, client]) => ({ id, client })));
  };
</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker
      .register("./sw.js")   // üëà RELATIVE path for GitHub Pages
      .then((reg) => {
        console.log("‚úÖ Service Worker registered:", reg.scope);
      })
      .catch((err) => {
        console.error("‚ùå Service Worker registration failed:", err);
      });
  });
}
</script>
