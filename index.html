<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Client Payment Tracker</title>

<style>
body { margin:0; font-family:Arial; background:#f4f6f9 }
h1 { background:#2e7d32; color:#fff; padding:15px; text-align:center; margin:0 }

#toolbar {
  display:flex;
  gap:8px;
  padding:10px;
  background:#333;
  overflow-x:auto;
}
#toolbar button {
  background:#4CAF50;
  color:#fff;
  border:none;
  padding:10px 14px;
  border-radius:4px;
  cursor:pointer;
  white-space:nowrap;
}
#toolbar button.active {
  background:gold;
  color:black;
}

.section {
  display:none;
  background:#fff;
  margin:10px;
  padding:15px;
  border-radius:6px;
}

input, select, button, textarea {
  width:100%;
  padding:10px;
  margin-top:8px;
  font-size:16px;
}

table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
th, td {
  border:1px solid #ccc;
  padding:8px;
}
th { background:#eee }

.debit-red { color:red; font-weight:bold }
.highlight { background:yellow }

.match-balance {
  background:#ffb3b3 !important;
  font-weight:bold;
}

.autocomplete { position:relative }
.autolist {
  position:absolute;
  background:#fff;
  border:1px solid #ccc;
  width:100%;
  z-index:100;
}
.autolist div {
  padding:8px;
  cursor:pointer;
}
.autolist div:hover { background:#eee }

.modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
}
.modal-content {
  background:#fff;
  width:95%;
  max-width:900px;
  margin:5% auto;
  padding:15px;
  border-radius:6px;
}

#logoutBtn {
  background:#c62828;
  color:#fff;
  margin:15px;
}

@media (max-width:768px){
  table, thead, tbody, th, td, tr { display:block }
  th { display:none }
  tr {
    margin-bottom:10px;
    border:1px solid #ddd;
    border-radius:6px;
    padding:8px;
  }
  td {
    display:flex;
    justify-content:space-between;
    padding:6px 0;
  }
}
</style>
</head>

<body>
<h1>Client Payment Tracker</h1>

<!-- LOGIN -->
<div id="authSection" class="section" style="display:block">
<input id="loginEmail" placeholder="Email">
<input id="loginPassword" type="password" placeholder="Password">
<button id="loginBtn">Login</button>
<button id="signupBtn">Sign Up</button>
</div>

<!-- APP -->
<div id="appSection" style="display:none">

<div id="toolbar">
<button data-sec="clients" class="active">Clients</button>
<button data-sec="charge">Add Charge</button>
<button data-sec="payment">Add Payment</button>
<button data-sec="expense">Expenses</button>
<button onclick="openAdmin()">Admin Report</button>
</div>

<!-- CLIENTS -->
<div id="clients" class="section" style="display:block">
<input id="clientSearch" placeholder="Search Client">
<select id="clientFilter">
<option value="all">All</option>
<option value="outstanding">Outstanding</option>
<option value="paid">Paid</option>
</select>
<table>
<thead><tr><th>Name</th><th>Debit</th><th>Credit</th><th>Balance</th><th>Action</th></tr></thead>
<tbody id="clientsBody"></tbody>
</table>
</div>

<!-- CHARGE -->
<div id="charge" class="section">
<div class="autocomplete">
<input id="chargeName" placeholder="Client Name">
<div id="chargeAuto" class="autolist"></div>
</div>

<select id="bookingType">
<option value="">Booking Type</option>
<option value="single">Single Day</option>
<option value="multi">Multi Day</option>
</select>

<div id="singleDay" style="display:none"><input id="singleDate" type="date"></div>
<div id="multiDay" style="display:none">
<input id="startDate" type="date">
<input id="endDate" type="date">
</div>

<input id="chargeAmount" type="number" placeholder="Amount">
<input id="chargeRemarks" placeholder="Remarks">
<button id="addChargeBtn">Save Charge</button>
</div>

<!-- PAYMENT -->
<div id="payment" class="section">
<div class="autocomplete">
<input id="paymentSearch" placeholder="Client Name">
<div id="paymentAuto" class="autolist"></div>
</div>

<input id="paymentBalance" readonly placeholder="Balance">
<input id="paymentAmount" type="number" placeholder="Amount">
<select id="paymentType">
<option>Cash</option>
<option>Bank Transfer</option>
<option>Credit Card</option>
<option>Others</option>
</select>
<select id="paymentMode">
<option>Full</option>
<option>Partial</option>
</select>
<input id="paymentRemarks" placeholder="Remarks">
<button id="addPaymentBtn">Save Payment</button>
</div>

<!-- EXPENSE -->
<div id="expense" class="section">
<input id="expenseDate" type="date">
<input id="expenseAmount" type="number" placeholder="Amount">
<input id="expenseDesc" placeholder="Description">
<button id="addExpenseBtn">Save Expense</button>

<h3>View Expenses</h3>
<input id="expStart" type="date">
<input id="expEnd" type="date">
<button onclick="viewExpenses()">Generate</button>
<div id="expenseResult"></div>
</div>

<!-- ADMIN -->
<div id="admin" class="section">
<textarea id="adminNotes" placeholder="Notes"></textarea>
<button id="saveNotesBtn">Save / Edit Note</button>

<h3>Admin Report</h3>
<input id="adminStart" type="date">
<input id="adminEnd" type="date">
<button onclick="generateAdminReport()">Generate Report</button>
<div id="adminResult"></div>
</div>

<!-- VIEW MODAL -->
<div id="viewModal" class="modal">
<div class="modal-content">
<button onclick="viewModal.style.display='none'">Close</button>
<h3 id="viewTitle"></h3>
<div id="viewSummary"></div>
<table>
<thead><tr><th>Date</th><th>Debit</th><th>Credit</th><th>Remarks</th></tr></thead>
<tbody id="viewBody"></tbody>
</table>
</div>
</div>

<button id="logoutBtn">Logout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const ADMIN_CODE="1234";

const app=initializeApp({
  apiKey:"AIzaSyCrtGcFZVwP6dlsc_Bljr_yN-nu6hxihVg",
  authDomain:"client-payment-tracker-3572b.firebaseapp.com",
  projectId:"client-payment-tracker-3572b"
});

const auth=getAuth(app);
const db=getFirestore(app);

let currentUser, clients={}, expenses=[];
const cid=n=>n.toLowerCase().replace(/\s+/g,'');

/* AUTH */
loginBtn.onclick=()=>signInWithEmailAndPassword(auth,loginEmail.value,loginPassword.value);
signupBtn.onclick=()=>createUserWithEmailAndPassword(auth,loginEmail.value,loginPassword.value);
logoutBtn.onclick=()=>signOut(auth);

onAuthStateChanged(auth,u=>{
  if(u){
    currentUser=u;
    authSection.style.display="none";
    appSection.style.display="block";
    loadClients();
    loadExpenses();
    adminNotes.value=localStorage.getItem("adminNotes")||"";
  }else{
    authSection.style.display="block";
    appSection.style.display="none";
  }
});

/* TOOLBAR */
document.querySelectorAll("#toolbar button[data-sec]").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll("#toolbar button").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    showSection(btn.dataset.sec);
  };
});

window.showSection=id=>{
  document.querySelectorAll(".section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
};

window.openAdmin=()=>{
  if(prompt("Enter Admin Code")===ADMIN_CODE){
    document.querySelectorAll("#toolbar button").forEach(b=>b.classList.remove("active"));
    showSection("admin");
  }
};

/* CLIENTS */
function loadClients(){
  onSnapshot(collection(db,"users",currentUser.uid,"clients"),snap=>{
    clients={};
    snap.forEach(d=>{
      const data=d.data();
      data.history=data.history||[];
      clients[d.id]=data;
    });
    renderClients();
  });
}

function highlight(text, term){
  if(!term) return text;
  return text.replace(new RegExp(`(${term})`,"gi"),'<span class="highlight">$1</span>');
}

window.renderClients=()=>{
  const term=clientSearch.value.toLowerCase();
  const filter=clientFilter.value;
  clientsBody.innerHTML="";

  Object.values(clients).forEach(c=>{
    const bal=(c.debit||0)-(c.credit||0);

    if(term && !c.name.toLowerCase().includes(term)) return;
    if(filter==="outstanding" && bal<=0) return;
    if(filter==="paid" && bal!==0) return;

    clientsBody.innerHTML+=`
    <tr>
      <td>${highlight(c.name,term)}</td>
      <td>${c.debit||0}</td>
      <td>${c.credit||0}</td>
      <td class="${bal>0?'debit-red':''}">${bal}</td>
      <td><button onclick="viewClient('${c.name}')">View</button></td>
    </tr>`;
  });
};

clientSearch.oninput=renderClients;
clientFilter.onchange=renderClients;

/* VIEW MODAL */
window.viewClient=name=>{
  const c=clients[cid(name)];
  let running=0;
  const outstanding=(c.debit||0)-(c.credit||0);

  viewTitle.textContent=name;
  viewSummary.textContent=`Outstanding Balance: ${outstanding}`;
  viewBody.innerHTML="";

  (c.history||[]).forEach(h=>{
    running+=(h.debit||0)-(h.credit||0);
    const match = running===outstanding ? "match-balance" : "";
    viewBody.innerHTML+=`
    <tr class="${match}">
      <td>${new Date(h.date).toLocaleString()}</td>
      <td>${h.debit||0}</td>
      <td>${h.credit||0}</td>
      <td>${h.remarks||""}</td>
    </tr>`;
  });
  viewModal.style.display="block";
};

/* AUTOCOMPLETE + PAYMENT AUTO */
paymentSearch.oninput=()=>{
  paymentAuto.innerHTML="";
  Object.values(clients).map(c=>c.name)
  .filter(n=>n.toLowerCase().includes(paymentSearch.value.toLowerCase()))
  .forEach(n=>{
    const d=document.createElement("div");
    d.textContent=n;
    d.onclick=()=>{
      paymentSearch.value=n;
      paymentAuto.innerHTML="";
      const c=clients[cid(n)];
      const bal=(c.debit||0)-(c.credit||0);
      paymentBalance.value=bal;
      paymentAmount.value=bal;
      paymentRemarks.value=`Payment for balance ${bal}`;
    };
    paymentAuto.appendChild(d);
  });
};

paymentMode.onchange=()=>{
  if(paymentMode.value==="Full"){
    paymentAmount.value=paymentBalance.value;
    paymentRemarks.value=`Payment for balance ${paymentBalance.value}`;
  }else{
    paymentAmount.value="";
  }
};
</script>
</body>
</html>
