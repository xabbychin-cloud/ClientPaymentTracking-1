<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Payment Tracker</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="stylesheet" href="./style.css">
  <style>
    /* Basic modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgb(0,0,0);
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    mark {
      background-color: yellow;
    }
    .history-table {
      width: 100%;
      border-collapse: collapse;
    }
    .history-table th, .history-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .history-table th {
      background-color: #f2f2f2;
    }
    /* Auth forms */
    #authContainer {
      display: block;
    }
    #appContainer {
      display: none;
    }
    .auth-form {
      max-width: 400px;
      margin: 50px auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .auth-form input {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
    }
    .auth-form button {
      width: 100%;
      padding: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .auth-form button:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <div id="authContainer">
    <div id="signupForm" class="auth-form">
      <h2>Create Account</h2>
      <input id="signupEmail" type="email" placeholder="Username" required>
      <input id="signupPassword" type="password" placeholder="Password" required>
      <button id="signupBtn">Create Account</button>
    </div>
  </div>

  <div id="appContainer">
    <h1>Client Payment Tracker</h1>

    <!-- Charge Form -->
    <form id="chargeForm">
      <input id="chargeFirstName" placeholder="First Name" required>
      <input id="chargeLastName" placeholder="Last Name" required>
      <input id="chargeAmount" type="number" placeholder="Amount" required>
      <input id="chargeRemarks" placeholder="Remarks">
      <button type="submit">Add Charge</button>
    </form>

    <!-- Payment Form -->
    <form id="paymentForm">
      <input id="firstName" placeholder="First Name" required>
      <input id="lastName" placeholder="Last Name" required>
      <input id="amount" type="number" placeholder="Amount" required>
      <input id="method" placeholder="Payment Method">
      <input id="remarks" placeholder="Remarks">
      <button type="submit">Add Payment</button>
    </form>

    <!-- Filter Buttons -->
    <button id="filterAll">All</button>
    <button id="filterOutstanding">Outstanding</button>
    <button id="filterPaid">Paid</button>

    <!-- Search Bar -->
    <input id="searchBox" placeholder="Search by name or remarks">

    <!-- Clients Table -->
    <table id="clientsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Debit</th>
          <th>Credit</th>
          <th>Balance</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Modal for Viewing Client Records -->
    <div id="viewModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeModal">&times;</span>
        <h2 id="modalTitle">Client Records</h2>
        <div id="modalSummary">
          <p><strong>Total Debit:</strong> <span id="totalDebit"></span></p>
          <p><strong>Total Credit:</strong> <span id="totalCredit"></span></p>
          <p><strong>Balance:</strong> <span id="balance"></span></p>
          <p><strong>Status:</strong> <span id="status"></span></p>
        </div>
        <h3>Transaction History</h3>
        <table class="history-table" id="historyTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Debit</th>
              <th>Credit</th>
              <th>Method</th>
              <th>Remarks</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>

    <button id="logoutBtn">Logout</button>
  </div>

  <!-- Firebase & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getAuth, createUserWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { 
      getFirestore, doc, getDoc, setDoc, onSnapshot, collection,
      enableIndexedDbPersistence 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCrtGcFZVwP6dlsc_Bljr_yN-nu6hxihVg",
      authDomain: "client-payment-tracker-3572b.firebaseapp.com",
      projectId: "client-payment-tracker-3572b",
      storageBucket: "client-payment-tracker-3572b.firebasestorage.app",
      messagingSenderId: "151091330895",
      appId: "1:151091330895:web:d23440ad57a386da720f3a",
      measurementId: "G-NH7D18261Q"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Enable offline persistence
    enableIndexedDbPersistence(db).catch((err) => {
      if (err.code === 'failed-precondition') {
        console.error("Persistence failed: multiple tabs open");
      } else if (err.code === 'unimplemented') {
        console.error("Persistence not supported by this browser");
      }
    });

    let currentUser = null;
    let clients = {};
    let currentFilter = "all";
    let searchQuery = "";

    // Function to generate client ID based on name (assuming unique names)
    function generateClientId(first, last) {
      return `${first}_${last}`.replace(/\s+/g, '_').toLowerCase();
    }

    // --- Auth Functions ---
    function showAuthContainer() {
      document.getElementById("authContainer").style.display = "block";
      document.getElementById("appContainer").style.display = "none";
    }

    function showAppContainer() {
      document.getElementById("authContainer").style.display = "none";
      document.getElementById("appContainer").style.display = "block";
    }

    // Signup (only auth method now)
    document.getElementById("signupBtn").addEventListener("click", async () => {
      const email = document.getElementById("signupEmail").value;
      const password = document.getElementById("signupPassword").value;
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        alert("Account created successfully!");  // Success prompt
      } catch (err) {
        alert("Signup failed: " + err.message);
      }
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      alert("Logged out!");
    });

    // Auth state listener (shows app if signed in)
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("User signed in:", user.email);
        currentUser = user;
        showAppContainer();
        loadClients();
      } else {
        console.log("No user signed in");
        currentUser = null;
        showAuthContainer();
      }
    });

    // --- Add Charge ---
    async function addCharge(first, last, amount, remarks) {
      if (!currentUser) return;
      const id = generateClientId(first, last);
      const ref = doc(db, "users", currentUser.uid, "clients", id);
      try {
        const snap = await getDoc(ref);
        const c = snap.exists() 
          ? snap.data() 
          : { firstName: first, lastName: last, debit: 0, credit: 0, history: [] };

        c.history.push({
          date: new Date().toLocaleString(),
          debit: amount,
          credit: 0,
          method: "charge",
          remarks
        });

        await setDoc(ref, { 
          firstName: first, 
          lastName: last, 
          debit: (c.debit || 0) + amount, 
          credit: c.credit || 0, 
          history: c.history 
        }, { merge: true });

        alert(`✅ Charge of ${amount} added for ${first} ${last} (Client ID: ${id})`);
      } catch (err) {
        console.error("Firestore write failed:", err);
        alert("⚠️ Failed to save client record: " + err.message);
      }
    }

    // --- Add Payment ---
    async function addPayment(first, last, amount, method, remarks) {
      if (!currentUser) return;
      const id = generateClientId(first, last);
      const ref = doc(db, "users", currentUser.uid, "clients", id);
      try {
        const snap = await getDoc(ref);
        const c = snap.exists() 
          ? snap.data() 
          : { firstName: first, lastName: last, debit: 0, credit: 0, history: [] };

        c.history.push({
          date: new Date().toLocaleString(),
          debit: 0,
          credit: amount,
          method,
          remarks
        });

        await setDoc(ref, { 
          firstName: first, 
          lastName: last, 
          debit: c.debit || 0, 
          credit: (c.credit || 0) + amount, 
          history: c.history 
        }, { merge: true });

        alert(`✅ Payment of ${amount} recorded for ${first} ${last} (Client ID: ${id})`);
      } catch (err) {
        console.error("Firestore write failed:", err);
        alert("⚠️ Failed to save client record: " + err.message);
      }
    }

    // --- View Client Records (Modal) ---
    async function viewClient(id) {
      if (!currentUser) return;
      const ref = doc(db, "users", currentUser.uid, "clients", id);
      try {
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const c = snap.data();
          const modal = document.getElementById("viewModal");
          const modalTitle = document.getElementById("modalTitle");
          const totalDebit = document.getElementById("totalDebit");
          const totalCredit = document.getElementById("totalCredit");
          const balance = document.getElementById("balance");
          const status = document.getElementById("status");
          const historyBody = document.getElementById("historyBody");

          modalTitle.textContent = `Records for ${c.firstName} ${c.lastName} (ID: ${id})`;
          totalDebit.textContent = (c.debit || 0).toFixed(2);
          totalCredit.textContent = (c.credit || 0).toFixed(2);
          const bal = (c.debit || 0) - (c.credit || 0);
          balance.textContent = bal.toFixed(2);
          status.textContent = bal > 0 ? "Outstanding" : "Paid";

          historyBody.innerHTML = "";
          c.history.forEach(h => {
            historyBody.insertAdjacentHTML("beforeend", `
              <tr>
                <td>${h.date}</td>
                <td>${h.debit.toFixed(2)}</td>
                <td>${h.credit.toFixed(2)}</td>
                <td>${h.method}</td>
                <td>${h.remarks}</td>
              </tr>
            `);
          });

          modal.style.display = "block";
        } else {
          alert("No records found for this client.");
        }
      } catch (err) {
        console.error("Error viewing client:", err);
        alert("⚠️ Unable to fetch client record (offline?).");
      }
    }

    // Expose viewClient to window for onclick
    window.viewClient = viewClient;

    // --- Load Clients (Realtime) ---
    function loadClients() {
      if (!currentUser) return;
      onSnapshot(collection(db, "users", currentUser.uid, "clients"), snap => {
        clients = {};
        snap.forEach(d => (clients[d.id] = d.data()));
        renderClients();
      });
    }

    // Function to highlight text
    function highlightText(text, query) {
      if (!query) return text;
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<mark>$1</mark>');
    }

    function renderClients() {
      const tbody = document.querySelector("#clientsTable tbody");
      if (!tbody) return;
      tbody.innerHTML = "";
      Object.entries(clients).forEach(([id, c]) => {
        const balance = (c.debit || 0) - (c.credit || 0);
        const status = balance > 0 ? "Outstanding" : "Paid";
        // --- Search filter by name OR remarks ---
        const fullName = `${c.firstName || ""} ${c.lastName || ""}`.toLowerCase();
        const remarksText = (c.history || []).map(h => h.remarks || "").join(" ").toLowerCase();

        if (searchQuery && !fullName.includes(searchQuery) && !remarksText.includes(searchQuery)) return;
        if (currentFilter !== "all" && status.toLowerCase() !== currentFilter) return;

        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td>${id}</td>
            <td>${highlightText(`${c.firstName} ${c.lastName}`, searchQuery)}</td>
            <td>${(c.debit || 0).toFixed(2)}</td>
            <td>${(c.credit || 0).toFixed(2)}</td>
            <td>${balance.toFixed(2)}</td>
            <td>${status}</td>
            <td><button onclick="viewClient('${id}')">View</button></td>
          </tr>
        `);
      });
    }

    // --- Event Listeners for Forms ---
    document.getElementById("chargeForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const first = document.getElementById("chargeFirstName").value;
      const last = document.getElementById("chargeLastName").value;
      const amount = parseFloat(document.getElementById("chargeAmount").value);
      const remarks = document.getElementById("chargeRemarks").value;
      addCharge(first, last, amount, remarks);
      e.target.reset();
    });

    document.getElementById("paymentForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const first = document.getElementById("firstName").value;
      const last = document.getElementById("lastName").value;
      const amount = parseFloat(document.getElementById("amount").value);
      const method = document.getElementById("method").value;
      const remarks = document.getElementById("remarks").value;
      addPayment(first, last, amount, method, remarks);
      e.target.reset();
    });

    // Filter buttons
    document.getElementById("filterAll").addEventListener("click", () => {
      currentFilter = "all";
      renderClients();
    });
    document.getElementById("filterOutstanding").addEventListener("click", () => {
      currentFilter = "outstanding";
      renderClients();
    });
    document.getElementById("filterPaid").addEventListener("click", () => {
      currentFilter = "paid";
      renderClients();
    });

    // Search
    document.getElementById("searchBox").addEventListener("input", (e) => {
      searchQuery = e.target.value.toLowerCase();
      renderClients();
    });

    // Close modal
    document.getElementById("closeModal").addEventListener("click", () => {
      document.getElementById("viewModal").style.display = "none";
    });
  </script>
</body>
</html>
