<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Client Payment Tracker</title>
<style>
body{margin:0;font-family:Arial;background:#f4f4f4}
h1{background:#2e7d32;color:white;padding:15px;text-align:center;margin:0}
#toolbar{display:flex;gap:8px;padding:10px;background:#333;overflow-x:auto}
#toolbar button{background:#4CAF50;color:white;border:none;padding:10px 14px;border-radius:4px;cursor:pointer}
#toolbar button:hover{background:#43a047}
.section{display:none;background:white;margin:10px;padding:15px;border-radius:6px}
input,select,button{width:100%;padding:8px;margin-top:6px}
button{cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:left}
th{background:#eee;color:black}
.debit-red{color:red;font-weight:bold}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5)}
.modal-content{background:white;width:95%;max-width:900px;margin:5% auto;padding:15px;max-height:80vh;overflow:auto}
.close{float:right;font-size:22px;cursor:pointer}
.readonly{background:#eee}
.autocomplete-box{position:relative}
.autocomplete-list{position:absolute;background:white;border:1px solid #ccc;width:100%;max-height:150px;overflow:auto;z-index:100}
.autocomplete-item{padding:6px;cursor:pointer}
.autocomplete-item:hover{background:#f0f0f0}
#logoutBtn{background:#c62828;color:white;margin:15px}
.highlight { font-weight: bold; background-color: yellow; }
.balance-outstanding { color: red; font-weight: bold; }
.balance-paid { color: black; }
</style>
</head>
<body>

<h1>Client Payment Tracker</h1>

<!-- LOGIN SECTION -->
<div id="authSection" class="section" style="display:block">
  <h3>Login</h3>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPassword" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
</div>

<!-- APP SECTION -->
<div id="appSection" style="display:none">

<div id="toolbar">
  <button onclick="showSection('clientSection')">Client Information</button>
  <button onclick="showSection('chargeSection')">Add Charge</button>
  <button onclick="showSection('paymentSection')">Add Payment</button>
  <button onclick="showSection('expenseSection')">Expenses</button>
  <button onclick="showSection('reportSection')">Admin Report</button>
</div>

<div id="clientSection" class="section">...</div>
<div id="chargeSection" class="section">...</div>
<div id="paymentSection" class="section">...</div>
<div id="expenseSection" class="section">...</div>
<div id="reportSection" class="section">...</div>

<button id="logoutBtn">Logout</button>

<!-- VIEW MODAL -->
<div id="viewModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeViewModal()">&times;</span>
    <h3 id="viewTitle"></h3>
    <div id="viewSummary" style="margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 4px;"></div>
    <table>
      <thead>
        <tr><th>Date</th><th>Debit</th><th>Credit</th><th>Method</th><th>Mode</th><th>Remarks</th><th>Start</th><th>End</th></tr>
      </thead>
      <tbody id="viewBody"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// ===== FIREBASE CONFIG =====
const app = initializeApp({
  apiKey: "AIzaSyCrtGcFZVwP6dlsc_Bljr_yN-nu6hxihVg",
  authDomain: "client-payment-tracker-3572b.firebaseapp.com",
  projectId: "client-payment-tracker-3572b",
  storageBucket: "client-payment-tracker-3572b.firebasestorage.app",
  messagingSenderId: "151091330895",
  appId: "1:151091330895:web:d23440ad57a386da720f3a",
  measurementId: "G-NH7D18261Q"
});

const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null, clients = {}, expenses = [];

const cid = n => n.toLowerCase().replace(/\s+/g, '_');
const formatDate = (isoString) => { if (!isoString) return ''; const d = new Date(isoString); return `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`; };
const highlightText = (text, query) => { if (!query) return text; const regex = new RegExp(`(${query})`, 'gi'); return text.replace(regex, '<span class="highlight">$1</span>'); };

// ===== DOM ELEMENTS =====
const authSection = document.getElementById("authSection");
const appSection = document.getElementById("appSection");
const loginBtn = document.getElementById("loginBtn");
const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const logoutBtn = document.getElementById("logoutBtn");

// ===== LOGIN =====
loginBtn.onclick = () => {
  const email = loginEmail.value.trim();
  const password = loginPassword.value.trim();
  if (!email || !password) {
    alert("Please enter email and password");
    return;
  }

  signInWithEmailAndPassword(auth, email, password)
    .then(userCredential => {
      console.log("Logged in as:", userCredential.user.email);
      loginEmail.value = ""; loginPassword.value = "";
    })
    .catch(e => alert("Login failed: " + e.message));
};

// ===== AUTH STATE =====
onAuthStateChanged(auth, u => {
  if (u) {
    currentUser = u;
    authSection.style.display = "none";
    appSection.style.display = "block";
    loadClients();
    loadExpenses();
  } else {
    currentUser = null;
    authSection.style.display = "block";
    appSection.style.display = "none";
  }
});

// ===== LOGOUT =====
logoutBtn.onclick = () => {
  signOut(auth)
    .then(() => alert("Logged out"))
    .catch(e => alert(e.message));
};

// ===== SHOW SECTION + HIGHLIGHT ACTIVE BUTTON =====
window.showSection = function(id) {
  document.querySelectorAll(".section").forEach(s => s.style.display = "none");
  const section = document.getElementById(id);
  if(section) section.style.display = "block";

  document.querySelectorAll("#toolbar button").forEach(b => b.style.backgroundColor = "#4CAF50");
  const activeBtn = Array.from(document.querySelectorAll("#toolbar button")).find(b => b.getAttribute("onclick")?.includes(`'${id}'`));
  if(activeBtn) activeBtn.style.backgroundColor = "#43a047";
};

// Optional: show "Client Information" on page load
window.addEventListener("DOMContentLoaded", () => {
  showSection('clientSection');
});
</script>

</div> <!-- End appSection -->
</body>
</html>
