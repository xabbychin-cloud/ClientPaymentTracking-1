<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Client Payment Tracker</title>

<style>
body{margin:0;font-family:Arial;background:#f5f5f5}
h1{background:#2e7d32;color:white;padding:15px;text-align:center;margin:0}
#toolbar{display:flex;gap:8px;padding:10px;background:#333;overflow-x:auto}
#toolbar button{background:#4CAF50;color:white;border:none;padding:10px 15px;border-radius:4px;cursor:pointer}
#toolbar button:hover{background:#43a047}

.section{display:none;background:white;margin:10px;padding:15px;border-radius:6px}
input,select,button{width:100%;padding:8px;margin-top:6px}
button{cursor:pointer}

table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:left}
th{background:#eee;color:black}

.debit-red{color:red;font-weight:bold}

.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5)}
.modal-content{background:white;width:95%;max-width:900px;margin:5% auto;padding:15px;max-height:80vh;overflow:auto}
.close{float:right;font-size:22px;cursor:pointer}

#logoutBtn{background:#d32f2f;color:white;margin:15px}

.readonly{background:#eee}
</style>
</head>

<body>

<h1>Client Payment Tracker</h1>

<div id="toolbar">
  <button onclick="showSection('chargeSection')">Add Charge</button>
  <button onclick="showSection('paymentSection')">Add Payment</button>
  <button onclick="showSection('expenseSection')">Expenses</button>
  <button onclick="showSection('reportSection')">Admin Report</button>
</div>

<!-- AUTH -->
<div id="authSection" class="section" style="display:block">
  <h3>Login</h3>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPassword" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
</div>

<div id="appSection" style="display:none">

<!-- ADD CHARGE -->
<div id="chargeSection" class="section">
  <h3>Add Charge</h3>
  <input id="chargeName" placeholder="Client Full Name">
  <input id="chargeAmount" type="number" placeholder="Amount">
  <input id="chargeStart" type="date">
  <input id="chargeEnd" type="date">
  <input id="chargeRemarks" placeholder="Remarks">
  <button id="addChargeBtn">Save Charge</button>
</div>

<!-- ADD PAYMENT -->
<div id="paymentSection" class="section">
  <h3>Add Payment</h3>

  <input id="paymentSearchName" placeholder="Search Client Name">
  <button onclick="searchClientForPayment()">Search</button>

  <input id="paymentClientName" readonly class="readonly">
  <input id="paymentBalance" readonly class="readonly">

  <table id="payablesTable">
    <thead>
      <tr><th>Date</th><th>Unpaid Amount</th><th>Remarks</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <input id="paymentAmount" type="number" placeholder="Payment Amount">
  <select id="paymentType">
    <option value="">Payment Type</option>
    <option>Cash</option>
    <option>Bank Transfer</option>
    <option>Credit Card</option>
    <option>Others</option>
  </select>
  <select id="paymentMode">
    <option value="">Payment Mode</option>
    <option>Full</option>
    <option>Partial</option>
  </select>
  <input id="paymentDate" type="date">
  <input id="paymentRemarks" placeholder="Remarks">
  <button id="addPaymentBtn">Save Payment</button>
</div>

<!-- CLIENT SEARCH -->
<div class="section" style="display:block">
  <input id="searchClientInput" placeholder="Search Client">
  <button onclick="renderClients()">Search</button>

  <select id="filterStatus" onchange="renderClients()">
    <option value="all">All</option>
    <option value="outstanding">Outstanding</option>
    <option value="paid">Paid</option>
  </select>

  <table id="clientsTable">
    <thead>
      <tr>
        <th>Name</th><th>Debit</th><th>Credit</th><th>Balance</th><th>Status</th><th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- VIEW MODAL -->
<div id="viewModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3 id="modalTitle"></h3>
    <table>
      <thead>
        <tr>
          <th>Date</th><th>Debit</th><th>Credit</th><th>Method</th>
          <th>Mode</th><th>Remarks</th><th>Start</th><th>End</th>
        </tr>
      </thead>
      <tbody id="modalBody"></tbody>
    </table>
  </div>
</div>

<button id="logoutBtn">Logout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCrtGcFZVwP6dlsc_Bljr_yN-nu6hxihVg",
  authDomain: "client-payment-tracker-3572b.firebaseapp.com",
  projectId: "client-payment-tracker-3572b"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser=null;
let clients={};

function clientId(name){return name.toLowerCase().replace(/\s+/g,'_')}

// LOGIN
document.getElementById("loginBtn").onclick=async()=>{
  try{
    await signInWithEmailAndPassword(auth,
      loginEmail.value, loginPassword.value);
  }catch(e){alert(e.message)}
};

onAuthStateChanged(auth,u=>{
  if(u){
    currentUser=u;
    authSection.style.display="none";
    appSection.style.display="block";
    loadClients();
  }
});

// LOAD CLIENTS
function loadClients(){
  onSnapshot(collection(db,"users",currentUser.uid,"clients"),snap=>{
    clients={};
    snap.forEach(d=>clients[d.id]=d.data());
    renderClients();
  });
}

// RENDER CLIENTS
window.renderClients=()=>{
  const q=searchClientInput.value.toLowerCase();
  const f=filterStatus.value;
  const tb=document.querySelector("#clientsTable tbody");
  tb.innerHTML="";
  Object.values(clients).forEach(c=>{
    const bal=(c.debit||0)-(c.credit||0);
    const status=bal>0?"outstanding":"paid";
    if(q && !c.name.toLowerCase().includes(q)) return;
    if(f!=="all" && f!==status) return;
    tb.innerHTML+=`
      <tr>
        <td>${c.name}</td>
        <td class="${bal>0?'debit-red':''}">${c.debit}</td>
        <td>${c.credit}</td>
        <td class="${bal>0?'debit-red':''}">${bal}</td>
        <td>${status}</td>
        <td><button onclick="viewClient('${c.name}')">View</button></td>
      </tr>`;
  });
};

// VIEW CLIENT
window.viewClient=(name)=>{
  const c=clients[clientId(name)];
  modalTitle.textContent=name;
  modalBody.innerHTML="";
  c.history.forEach(h=>{
    modalBody.innerHTML+=`
    <tr>
      <td>${h.date}</td>
      <td class="${h.debit>0?'debit-red':''}">${h.debit}</td>
      <td>${h.credit}</td>
      <td>${h.method}</td>
      <td>${h.mode||''}</td>
      <td>${h.remarks||''}</td>
      <td>${h.start||''}</td>
      <td>${h.end||''}</td>
    </tr>`;
  });
  viewModal.style.display="block";
};

window.closeModal=()=>viewModal.style.display="none";

window.showSection=id=>{
  document.querySelectorAll(".section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
};

logoutBtn.onclick=()=>signOut(auth);
</script>

</body>
</html>
