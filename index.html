<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore,
  doc,
  getDoc,
  setDoc,
  onSnapshot,
  collection
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

document.addEventListener("DOMContentLoaded", () => {

  const firebaseConfig = {
    apiKey: "AIzaSyCrtGcFZVwP6dlsc_Bljr_yN-nu6hxihVg",
    authDomain: "client-payment-tracker-3572b.firebaseapp.com",
    projectId: "client-payment-tracker-3572b",
    storageBucket: "client-payment-tracker-3572b.firebasestorage.app",
    messagingSenderId: "151091330895",
    appId: "1:151091330895:web:d23440ad57a386da720f3a"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // DOM REFERENCES
  const chargeForm = document.getElementById("chargeForm");
  const paymentForm = document.getElementById("paymentForm");
  const filterAll = document.getElementById("filterAll");
  const filterOutstanding = document.getElementById("filterOutstanding");
  const filterPaid = document.getElementById("filterPaid");

  let clients = {};
  let currentFilter = "all";

  const balanceOf = c => (c.debit || 0) - (c.credit || 0);

  async function addCharge(id, first, last, amount, remarks) {
    const ref = doc(db, "clients", id);
    const snap = await getDoc(ref);
    const c = snap.exists()
      ? snap.data()
      : { firstName: first, lastName: last, debit: 0, credit: 0, history: [] };

    c.history.push({
      date: new Date().toLocaleString(),
      debit: amount,
      credit: 0,
      method: "charge",
      remarks
    });

    await setDoc(ref, {
      ...c,
      debit: (c.debit || 0) + amount
    });

    alert("Charge added");
  }

  async function addPayment(id, first, last, amount, method, remarks) {
    const ref = doc(db, "clients", id);
    const snap = await getDoc(ref);
    const c = snap.exists()
      ? snap.data()
      : { firstName: first, lastName: last, debit: 0, credit: 0, history: [] };

    c.history.push({
      date: new Date().toLocaleString(),
      debit: 0,
      credit: amount,
      method,
      remarks
    });

    await setDoc(ref, {
      ...c,
      credit: (c.credit || 0) + amount
    });

    alert("Payment added");
  }

  onSnapshot(collection(db, "clients"), snap => {
    clients = {};
    snap.forEach(d => (clients[d.id] = d.data()));
    renderClients();
  });

  function renderClients() {
    const tbody = document.querySelector("#clientsTable tbody");
    if (!tbody) return;

    tbody.innerHTML = "";

    Object.entries(clients).forEach(([id, c]) => {
      const balance = balanceOf(c);
      const status = balance > 0 ? "Outstanding" : "Paid";
      if (currentFilter !== "all" && status.toLowerCase() !== currentFilter) return;

      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${id}</td>
          <td>${c.firstName || ""} ${c.lastName || ""}</td>
          <td>${(c.debit || 0).toFixed(2)}</td>
          <td>${(c.credit || 0).toFixed(2)}</td>
          <td>${balance.toFixed(2)}</td>
          <td>${status}</td>
        </tr>
      `);
    });
  }

  chargeForm?.addEventListener("submit", e => {
    e.preventDefault();
    addCharge(
      chargeClientId.value,
      chargeFirstName.value,
      chargeLastName.value,
      parseFloat(chargeAmount.value),
      chargeRemarks.value
    );
    chargeForm.reset();
  });

  paymentForm?.addEventListener("submit", e => {
    e.preventDefault();
    addPayment(
      clientId.value,
      firstName.value,
      lastName.value,
      parseFloat(amount.value),
      method.value,
      remarks.value
    );
    paymentForm.reset();
  });

  filterAll.onclick = () => { currentFilter = "all"; renderClients(); };
  filterOutstanding.onclick = () => { currentFilter = "outstanding"; renderClients(); };
  filterPaid.onclick = () => { currentFilter = "paid"; renderClients(); };

});
</script>
