<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    onSnapshot,
    collection
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // ðŸ”¥ Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCrtGcFZVwP6dlsc_Bljr_yN-nu6hxihVg",
    authDomain: "client-payment-tracker-3572b.firebaseapp.com",
    projectId: "client-payment-tracker-3572b",
    storageBucket: "client-payment-tracker-3572b.firebasestorage.app",
    messagingSenderId: "151091330895",
    appId: "1:151091330895:web:d23440ad57a386da720f3a",
    measurementId: "G-NH7D18261Q"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let clients = {};
  let currentFilter = "all";

  const balanceOf = c => (c.debit || 0) - (c.credit || 0);

  // âž• Add Charge
  async function addCharge(id, first, last, amount, remarks) {
    const ref = doc(db, "clients", id);
    const snap = await getDoc(ref);

    const client = snap.exists()
      ? snap.data()
      : { firstName: first, lastName: last, debit: 0, credit: 0, history: [] };

    client.history.push({
      date: new Date().toLocaleString(),
      debit: amount,
      credit: 0,
      method: "charge",
      remarks
    });

    await setDoc(ref, {
      ...client,
      firstName: first,
      lastName: last,
      debit: (client.debit || 0) + amount
    });

    alert("Charge added successfully");
  }

  // âž• Add Payment
  async function addPayment(id, first, last, amount, method, remarks) {
    const ref = doc(db, "clients", id);
    const snap = await getDoc(ref);

    const client = snap.exists()
      ? snap.data()
      : { firstName: first, lastName: last, debit: 0, credit: 0, history: [] };

    client.history.push({
      date: new Date().toLocaleString(),
      debit: 0,
      credit: amount,
      method,
      remarks
    });

    await setDoc(ref, {
      ...client,
      firstName: first,
      lastName: last,
      credit: (client.credit || 0) + amount
    });

    alert("Payment added successfully");
  }

  // ðŸ”„ Live updates
  onSnapshot(collection(db, "clients"), snap => {
    clients = {};
    snap.forEach(d => (clients[d.id] = d.data()));
    renderClients();
  });

  // ðŸ“Š Render client summary table
  function renderClients() {
    const tbody = document.querySelector("#clientsTable tbody");
    tbody.innerHTML = "";

    Object.entries(clients).forEach(([id, c]) => {
      const balance = balanceOf(c);
      const status = balance > 0 ? "Outstanding" : "Paid";

      if (currentFilter !== "all" && status.toLowerCase() !== currentFilter) return;

      const last = c.history?.[c.history.length - 1] || {};

      tbody.insertAdjacentHTML(
        "beforeend",
        `
        <tr>
          <td>${id}</td>
          <td>${c.firstName || ""} ${c.lastName || ""}</td>
          <td>${(c.debit || 0).toFixed(2)}</td>
          <td>${(c.credit || 0).toFixed(2)}</td>
          <td>${balance.toFixed(2)}</td>
          <td>${status}</td>
          <td>${last.date || ""}</td>
          <td>${last.remarks || ""}</td>
        </tr>
      `
      );
    });
  }

  // ðŸ“œ Render history table
  function renderHistory(list) {
    const tbody = document.querySelector("#historyTable tbody");
    tbody.innerHTML = "";

    list.forEach(({ id, client }) => {
      client.history.forEach(h => {
        tbody.insertAdjacentHTML(
          "beforeend",
          `
          <tr>
            <td>${id}</td>
            <td>${client.firstName} ${client.lastName}</td>
            <td>${h.date}</td>
            <td>${h.debit.toFixed(2)}</td>
            <td>${h.credit.toFixed(2)}</td>
            <td>${h.method}</td>
            <td>${h.remarks || ""}</td>
          </tr>
        `
        );
      });
    });
  }

  // ðŸ§¾ Forms
  chargeForm.onsubmit = e => {
    e.preventDefault();
    addCharge(
      chargeClientId.value,
      chargeFirstName.value,
      chargeLastName.value,
      parseFloat(chargeAmount.value),
      chargeRemarks.value
    );
    chargeForm.reset();
  };

  paymentForm.onsubmit = e => {
    e.preventDefault();
    addPayment(
      clientId.value,
      firstName.value,
      lastName.value,
      parseFloat(amount.value),
      method.value,
      remarks.value
    );
    paymentForm.reset();
  };

  // ðŸŽ¯ Filters
  filterAll.onclick = () => { currentFilter = "all"; renderClients(); };
  filterOutstanding.onclick = () => { currentFilter = "outstanding"; renderClients(); };
  filterPaid.onclick = () => { currentFilter = "paid"; renderClients(); };

  // ðŸ” Search
  searchBtn.onclick = () => {
    const term = searchInput.value.toLowerCase();
    const matches = Object.entries(clients)
      .filter(([id, c]) =>
        id.toLowerCase().includes(term) ||
        c.firstName?.toLowerCase().includes(term) ||
        c.lastName?.toLowerCase().includes(term)
      )
      .map(([id, client]) => ({ id, client }));

    renderHistory(matches);
  };

  viewAllBtn.onclick = () => {
    renderHistory(
      Object.entries(clients).map(([id, client]) => ({ id, client }))
    );
  };
</script>
