<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Client Payment Tracker</title>

<style>
body { margin:0; font-family:Arial; background:#f4f6f9 }
h1 { background:#2e7d32; color:#fff; padding:15px; text-align:center; margin:0 }

#toolbar {
  display:flex;
  gap:8px;
  padding:10px;
  background:#333;
  overflow-x:auto;
}
#toolbar button {
  background:#4CAF50;
  color:#fff;
  border:none;
  padding:12px 16px;
  border-radius:4px;
  cursor:pointer;
  white-space:nowrap;
}
#toolbar button.active {
  background:gold;
  color:black;
}

.section { display:none; background:#fff; margin:10px; padding:15px; border-radius:6px }

input, select, button, textarea {
  width:100%;
  padding:10px;
  margin-top:8px;
  font-size:16px;
}

table { width:100%; border-collapse:collapse; margin-top:10px }
th, td { border:1px solid #ccc; padding:8px }
th { background:#eee }

.debit-red { color:red; font-weight:bold }

/* Highlight ONLY matching outstanding balance */
.match-balance {
  background:#ffcccc;
  font-weight:bold;
}

.autocomplete { position:relative }
.autolist {
  position:absolute;
  background:#fff;
  border:1px solid #ccc;
  width:100%;
  z-index:100;
}
.autolist div { padding:10px; cursor:pointer }
.autolist div:hover { background:#eee }

.modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
}
.modal-content {
  background:#fff;
  width:95%;
  max-width:900px;
  margin:5% auto;
  padding:15px;
  border-radius:6px;
  max-height:90vh;
  overflow:auto;
}

#logoutBtn {
  background:#c62828;
  color:#fff;
  margin:15px;
}

/* ---------- MOBILE FRIENDLY ---------- */
@media (max-width:768px){
  table, thead, tbody, th, td, tr { display:block }
  th { display:none }
  tr {
    margin-bottom:10px;
    border:1px solid #ddd;
    border-radius:6px;
    padding:8px;
  }
  td {
    display:flex;
    justify-content:space-between;
    padding:6px 0;
  }
}
</style>
</head>

<body>
<h1>Client Payment Tracker</h1>

<!-- LOGIN -->
<div id="authSection" class="section" style="display:block">
<input id="loginEmail" placeholder="Email">
<input id="loginPassword" type="password" placeholder="Password">
<button id="loginBtn">Login</button>
<button id="signupBtn">Sign Up</button>
<button id="forgotPasswordBtn">Forgot Password?</button>
<div id="forgotPasswordSection" style="display:none; margin-top:10px;">
<input id="forgotEmail" placeholder="Enter your email address">
<button id="sendResetBtn">Send Reset Email</button>
</div>
<div id="authError" style="color:red; margin-top:10px;"></div>  <!-- Added for error display -->
</div>

<!-- APP -->
<div id="appSection" style="display:none">
<!-- NEW: User Greeting -->
<div id="userGreeting" style="text-align: center; font-size: 18px; margin-bottom: 10px; color: #2e7d32;"></div>

<div id="toolbar">
<button data-sec="clients" class="active">Clients</button>
<button data-sec="charge">Add Charge</button>
<button data-sec="payment">Add Payment</button>
<button data-sec="expense">Expenses</button>
<button data-sec="dailySales">Daily Sales Report</button>
<button onclick="openAdmin()">Admin Report</button>
</div>

<!-- CLIENTS -->
<div id="clients" class="section" style="display:block">
<input id="clientSearch" placeholder="Search Client">
<select id="clientFilter">
<option value="all">All</option>
<option value="outstanding">Outstanding</option>
<option value="paid">Paid</option>
</select>
<table>
<thead><tr><th>Name</th><th>Debit</th><th>Credit</th><th>Balance</th><th>Action</th></tr></thead>
<tbody id="clientsBody"></tbody>
</table>
</div>

<!-- CHARGE -->
<div id="charge" class="section">
<div class="autocomplete">
<input id="chargeName" placeholder="Client Name">
<div id="chargeAuto" class="autolist"></div>
</div>

<select id="bookingType">
<option value="">Booking Type</option>
<option value="single">Single Day</option>
<option value="multi">Multi Day</option>
</select>

<div id="singleDay" style="display:none"><input id="singleDate" type="date"></div>
<div id="multiDay" style="display:none">
<input id="startDate" type="date">
<input id="endDate" type="date">
</div>

<input id="chargeAmount" type="number" placeholder="Amount">
<input id="chargeDiscount" type="number" placeholder="Discount Amount" value="0">
<input id="discountRemarks" placeholder="Discount Remarks">
<input id="chargeRemarks" placeholder="Remarks">
<button id="addChargeBtn">Save Charge</button>
</div>

<!-- PAYMENT -->
<div id="payment" class="section">
<div class="autocomplete">
<input id="paymentSearch" placeholder="Client Name">
<div id="paymentAuto" class="autolist"></div>
</div>

<input id="paymentBalance" readonly placeholder="Balance">
<input id="paymentAmount" type="number" placeholder="Amount">
<input id="paymentAdjustment" type="number" placeholder="Adjustment Amount (positive or negative)">
<input id="adjustmentRemarks" placeholder="Adjustment Remarks">
<select id="paymentType">
<option>Cash</option>
<option>Bank Transfer</option>
<option>Credit Card</option>
<option>Others</option>
</select>
<select id="paymentMode">
<option>Full</option>
<option>Partial</option>
</select>
<select id="paymentBranch">
<option value="">Select Branch</option>
<option value="Main">Main</option>
<option value="Branch 1">Branch 1</option>
<option value="Branch 2">Branch 2</option>
</select>
<input id="paymentRemarks" placeholder="Remarks">
<div id="remarksAuto" class="autolist"></div>
<div id="outstandingList" class="outstanding-list" style="display:none;"></div>
<button id="addPaymentBtn">Save Payment</button>
</div>

<!-- EXPENSE -->
<div id="expense" class="section">
<input id="expenseDate" type="date">
<input id="expenseAmount" type="number" placeholder="Amount">
<input id="expenseDesc" placeholder="Description">
<button id="addExpenseBtn">Save Expense</button>

<h3>View Expenses</h3>
<input id="expStart" type="date">
<input id="expEnd" type="date">
<button onclick="viewExpenses()">Generate</button>
<div id="expenseResult"></div>
</div>

<!-- DAILY SALES REPORT -->
<div id="dailySales" class="section">
<h3>Daily Sales Report</h3>
<input id="salesStart" type="date">
<input id="salesEnd" type="date">
<select id="salesBranch">
<option value="">All Branches</option>
<option value="Main">Main</option>
<option value="Branch 1">Branch 1</option>
<option value="Branch 2">Branch 2</option>
</select>
<button onclick="generateDailySalesReport()">Generate Report</button>
<div id="salesResult"></div>
</div>

<!-- ADMIN -->
<div id="admin" class="section">
<button id="toggleNotesBtn">Hide Notes</button>
<textarea id="adminNotes" placeholder="Notes"></textarea>
<button id="saveNotesBtn">Save / Edit Note</button>

<!-- NEW: Change Admin Code Section -->
<h4>Change Admin Code</h4>
<input id="newAdminCode" type="password" placeholder="Enter new admin code">
<button id="changeAdminCodeBtn">Change Code</button>
<button id="forgotAdminCodeBtn">Forgot Admin Code?</button>

<h3>Admin Report</h3>
<input id="adminStart" type="date">
<input id="adminEnd" type="date">
<button onclick="generateAdminReport()">Generate Report</button>
<div id="adminResult"></div>
</div>

<!-- NEW: Forgot Admin Code Modal -->
<div id="forgotAdminCodeModal" class="modal">
<div class="modal-content" style="width: 300px; margin: 20% auto;">
<h3>Forgot Admin Code</h3>
<p id="captchaQuestion">What is 2 + 2? (Enter the number)</p>
<input id="captchaAnswer" placeholder="Answer" style="width: 100%; margin-bottom: 10px;">
<input id="newForgotAdminCode" type="password" placeholder="New Admin Code" style="width: 100%; margin-bottom: 10px;">
<button id="resetAdminCodeBtn" style="width: 100%;">Reset Code</button>
<button onclick="forgotAdminCodeModal.style.display='none'" style="width: 100%; margin-top: 10px;">Cancel</button>
<div id="forgotError" style="color:red; margin-top:10px;"></div>
</div>
</div>

forgotAdminCodeBtn.onclick = () => {
  forgotAdminCodeModal.style.display = 'block';
  captchaAnswer.focus();
  forgotError.textContent = '';
};

resetAdminCodeBtn.onclick = async () => {
  const answer = captchaAnswer.value.trim();
  const correctAnswer = "4"; // Matches the question "What is 2 + 2?"
  if (answer !== correctAnswer) {
    forgotError.textContent = "Incorrect captcha answer. Try again.";
    return;
  }
  const newCode = newForgotAdminCode.value.trim();
  if (!newCode) {
    forgotError.textContent = "Please enter a new admin code.";
    return;
  }
  const adminRef = doc(db, "users", currentUser.uid, "settings", "admin");
  await setDoc(adminRef, { code: newCode }, { merge: true });
  window.currentAdminCode = newCode;
  alert("Admin code reset successfully!");
  forgotAdminCodeModal.style.display = 'none';
  captchaAnswer.value = '';
  newForgotAdminCode.value = '';
};

<!-- VIEW MODAL -->
<div id="viewModal" class="modal">
<div class="modal-content">
<button onclick="viewModal.style.display='none'">Close</button>
<h3 id="viewTitle"></h3>
<div id="viewSummary"></div>
<div style="overflow: auto; max-height: 70vh;">
<table>
<thead><tr><th>Date</th><th>Start Date</th><th>End Date</th><th>Debit</th><th>Credit</th><th>Branch</th><th>Remarks</th></tr></thead>
<tbody id="viewBody"></tbody>
</table>
</div>
</div>
</div>

<!-- ADMIN CODE MODAL -->
<div id="adminCodeModal" class="modal">
<div class="modal-content" style="width: 300px; margin: 20% auto;">
<h3>Enter Admin Code</h3>
<input id="adminCodeInput" type="password" placeholder="Admin Code" style="width: 100%; margin-bottom: 10px;">
<button id="submitAdminCodeBtn" style="width: 100%;">Submit</button>
<button onclick="adminCodeModal.style.display='none'" style="width: 100%; margin-top: 10px;">Cancel</button>
</div>
</div>

<button id="logoutBtn">Logout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, onSnapshot, addDoc, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyCrtGcFZVwP6dlsc_Bljr_yN-nu6hxihVg",
  authDomain: "client-payment-tracker-3572b.firebaseapp.com",
  projectId: "client-payment-tracker-3572b"
});

const auth = getAuth(app);
const db = getFirestore(app);

let currentUser, clients = {}, expenses = [];

const cid = n => n.toLowerCase().replace(/\s+/g, '_');

loginBtn.onclick = async () => {
  try {
    await signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
    alert("Login successful!");
  } catch (error) {
    authError.textContent = `Login failed: ${error.message}`;
  }
};

signupBtn.onclick = async () => {
  try {
    await createUserWithEmailAndPassword(auth, loginEmail.value, loginPassword.value);
    alert("Signup successful! You can now log in.");
  } catch (error) {
    authError.textContent = `Signup failed: ${error.message}`;
  }
};

forgotPasswordBtn.onclick = () => {
  forgotPasswordSection.style.display = 'block';
  forgotEmail.focus();
};

sendResetBtn.onclick = async () => {
  const email = forgotEmail.value.trim();
  if (!email) {
    authError.textContent = "Please enter your email address.";
    return;
  }
  // Simple text captcha
  const captchaQuestion = "What is 5 + 3?";
  const correctAnswer = "8";
  const userAnswer = prompt(`${captchaQuestion} (Enter the number)`);
  if (userAnswer !== correctAnswer) {
    authError.textContent = "Incorrect captcha. Please try again.";
    return;
  }
  try {
    await sendPasswordResetEmail(auth, email);
    alert("Password reset email sent! Check your inbox.");
    authError.textContent = "";
    forgotPasswordSection.style.display = 'none';
    forgotEmail.value = '';
  } catch (error) {
    authError.textContent = `Error: ${error.message}`;
  }
};

logoutBtn.onclick = () => signOut(auth);
onAuthStateChanged(auth, async u => {
  if (u) {
    currentUser = u;
    authSection.style.display = "none";
    appSection.style.display = "block";
    loadClients();
    loadExpenses();
    
    const adminRef = doc(db, "users", currentUser.uid, "settings", "admin");
    const adminSnap = await getDoc(adminRef);
    if (adminSnap.exists()) {
      const data = adminSnap.data();
      adminNotes.value = data.notes || "";
      window.currentAdminCode = data.code || null;
    } else {
      adminNotes.value = "";
      window.currentAdminCode = null;
    }
    
    const displayName = currentUser.displayName || currentUser.email.split('@')[0];
    userGreeting.textContent = `Hi ${displayName}! (user:${currentUser.email})`;
    userGreeting.style.display = "block";
  } else {
    authSection.style.display = "block";
    appSection.style.display = "none";
    userGreeting.style.display = "none";
  }
});

// Initialize notes as visible on load
adminNotes.style.display = 'block';
toggleNotesBtn.textContent = 'Hide Notes';

toggleNotesBtn.onclick = () => {
  if (adminNotes.style.display === 'none') {
    adminNotes.style.display = 'block';
    toggleNotesBtn.textContent = 'Hide Notes';
  } else {
    adminNotes.style.display = 'none';
    toggleNotesBtn.textContent = 'View Notes';
  }
};

/* ---------- TOOLBAR ACTIVE FIX ---------- */
document.querySelectorAll("#toolbar button[data-sec]").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll("#toolbar button").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    showSection(btn.dataset.sec);
  };
});

window.showSection = id => {
  document.querySelectorAll(".section").forEach(s => s.style.display = "none");
  document.getElementById(id).style.display = "block";
};

window.openAdmin = () => {
  adminCodeModal.style.display = 'block';
  adminCodeInput.focus();
};

submitAdminCodeBtn.onclick = () => {
  const enteredCode = adminCodeInput.value;
  const userCode = window.currentAdminCode;
  const defaultCode = "admin123";
  if (enteredCode === userCode || (enteredCode === defaultCode && !userCode)) {
    document.querySelectorAll("#toolbar button").forEach(b => b.classList.remove("active"));
    showSection("admin");
    adminCodeModal.style.display = 'none';
    adminCodeInput.value = '';
  } else {
    alert("Incorrect Admin Code");
    adminCodeInput.value = '';
  }
};

/* ---------- CLIENTS ---------- */
function loadClients() {
  onSnapshot(collection(db, "users", currentUser.uid, "clients"), snap => {
    clients = {};
    snap.forEach(d => clients[d.id] = d.data());
    renderClients();
  });
}

window.renderClients = () => {
  const searchTerm = clientSearch.value.toLowerCase();
  const filter = clientFilter.value;
  clientsBody.innerHTML = "";
  Object.values(clients).forEach(c => {
    const bal = (c.debit || 0) - (c.credit || 0);
    let show = true;
    if (filter === "outstanding" && bal <= 0) show = false;
    if (filter === "paid" && bal > 0) show = false;
    if (searchTerm && !c.name.toLowerCase().includes(searchTerm) && !bal.toString().includes(searchTerm)) show = false;
    if (show) {
      const highlightedName = c.name.replace(new RegExp(`(${searchTerm})`, 'gi'), '<mark>$1</mark>');
      const highlightedBal = bal.toString().replace(new RegExp(`(${searchTerm})`, 'gi'), '<mark>$1</mark>');
      clientsBody.innerHTML += `
      <tr>
        <td>${highlightedName}</td>
        <td>${c.debit || 0}</td>
        <td>${c.credit || 0}</td>
        <td class="${bal > 0 ? 'debit-red' : ''}">${highlightedBal}</td>
        <td><button onclick="viewClient('${c.name}')">View</button></td>
      </tr>`;
    }
  });
};

// Add event listeners for search and filter
clientSearch.oninput = renderClients;
clientFilter.onchange = renderClients;

/* ---------- VIEW MODAL ---------- */
window.viewClient = name => {
  const c = clients[cid(name)];
  const outstanding = (c.debit || 0) - (c.credit || 0);
  let running = 0;

  viewTitle.textContent = name;
  const outstandingClass = outstanding > 0 ? 'debit-red' : '';
  viewSummary.innerHTML = `Outstanding Balance: <span class="${outstandingClass}">${outstanding}</span><br>Total Debit: ${c.debit || 0}<br>Total Credit: ${c.credit || 0}`;
  viewBody.innerHTML = "";

  const sortedHistory = (c.history || []).sort((a, b) => new Date(a.date) - new Date(b.date));

  const unpaidIndices = [];
  running = 0;
  for (let i = 0; i < sortedHistory.length; i++) {
    const h = sortedHistory[i];
    running += (h.debit || 0) - (h.credit || 0);
    if (h.debit && running > 0) {
      unpaidIndices.push(i);
    }
  }

  running = 0;
  for (let i = 0; i < sortedHistory.length; i++) {
    const h = sortedHistory[i];
    running += (h.debit || 0) - (h.credit || 0);
    let rowClass = "";
    let debitClass = "";
    let creditClass = "";
    if (unpaidIndices.includes(i)) {
      rowClass = "highlight-row";  // Highlight the entire row for outstanding debits
      debitClass = "debit-bold";
    }
    if (h.credit) {
      creditClass = "credit-italic";
    }
    if (h.debit && !unpaidIndices.includes(i)) {
      debitClass = "debit-bold";  // Apply bold to all debit rows
    }

    // Enhanced Debit display for charges: show net, original, and discount
    let debitDisplay = h.debit || 0;
    if (h.debit) {
      const originalAmount = (h.debit || 0) + (h.discount || 0);
      const discountAmount = h.discount || 0;
      debitDisplay = `Net: ${h.debit} (Original: ${originalAmount} - Discount: ${discountAmount})`;
    }

    // Enhanced Remarks: include discount remarks if present
    let remarksDisplay = h.remarks || "";
    if (h.discountRemarks) {
      remarksDisplay += ` (Discount: ${h.discountRemarks})`;
    }

    viewBody.innerHTML += `
    <tr class="${rowClass}">
      <td>${new Date(h.date).toLocaleString()}</td>
      <td>${h.startDate || ""}</td>
      <td>${h.endDate || ""}</td>
      <td class="${debitClass}">${debitDisplay}</td>
      <td class="${creditClass}">${h.credit || 0}</td>
      <td>${h.branch || ""}</td>
      <td>${remarksDisplay}</td>
    </tr>`;
  }
  viewModal.style.display = "block";
};
  
/* ---------- AUTOCOMPLETE ---------- */
chargeName.oninput = () => {
  chargeAuto.innerHTML = "";
  Object.values(clients).map(c => c.name)
    .filter(n => n.toLowerCase().includes(chargeName.value.toLowerCase()))
    .forEach(n => {
      const d = document.createElement("div");
      d.textContent = n;
      d.onclick = () => { chargeName.value = n; chargeAuto.innerHTML = ""; };
      chargeAuto.appendChild(d);
    });
};

paymentSearch.oninput = () => {
  paymentAuto.innerHTML = "";
  Object.values(clients).map(c => c.name)
    .filter(n => n.toLowerCase().includes(paymentSearch.value.toLowerCase()))
    .forEach(n => {
      const d = document.createElement("div");
      d.textContent = n;
      d.onclick = () => {
        paymentSearch.value = n;
        paymentAuto.innerHTML = "";
        const c = clients[cid(n)];
        paymentBalance.value = (c.debit || 0) - (c.credit || 0);
        paymentRemarks.value = '';
        populateRemarksAuto(c);  // Populate clickable remarks dropdown
        populateOutstanding(c);
      };
      paymentAuto.appendChild(d);
    });
};

    function populateRemarksAuto(client) {
  remarksAuto.innerHTML = "";
  const sortedHistory = (client.history || []).sort((a, b) => new Date(a.date) - new Date(b.date));
  
  sortedHistory.forEach((h) => {
    if (h.debit) {
      // Check if there is a matching payment later in the history
      const matchingPayment = sortedHistory.find(later => 
        new Date(later.date) > new Date(h.date) && 
        later.credit && 
        later.remarks && 
        later.remarks.includes(h.remarks || "") && 
        later.remarks.includes(h.debit.toString()) && 
        later.remarks.includes(h.startDate || "") && 
        later.remarks.includes(h.endDate || "")
      );
      
      if (!matchingPayment) {
        const div = document.createElement("div");
        div.className = "outstanding-item";
        div.innerHTML = `<strong>Remarks: ${h.remarks || ""}</strong><br>Amount: ${h.debit}<br>Start: ${h.startDate || ""}, End: ${h.endDate || ""}`;
        div.onclick = () => {
          paymentRemarks.value = `Payment for: ${h.remarks || ""} (Amount: ${h.debit}, Start: ${h.startDate || ""}, End: ${h.endDate || ""})`;
          remarksAuto.innerHTML = "";  // Hide dropdown after selection
          if (paymentMode.value === 'Partial') {
            paymentAmount.value = h.debit;
          }
        };
        remarksAuto.appendChild(div);
      }
    }
  });

  if (remarksAuto.children.length === 0) {
    remarksAuto.style.display = 'none';
  } else {
    remarksAuto.style.display = 'block';
  }
}

  function getUnpaidDebitSummary(client) {
  const sortedHistory = (client.history || []).sort((a, b) => new Date(a.date) - new Date(b.date));
  let running = 0;
  const summaries = [];
  sortedHistory.forEach((h) => {
    running += (h.debit || 0) - (h.credit || 0);
    if (h.debit && running > 0) {
      summaries.push(`${h.remarks || 'No remarks'} (Amount: ${h.debit})`);
    }
  });
  return summaries.length > 0 ? summaries.join(', ') : null;
}

function populateOutstanding(client) {
  outstandingList.innerHTML = "";
  const sortedHistory = (client.history || []).sort((a, b) => new Date(a.date) - new Date(b.date));
  let running = 0;

  sortedHistory.forEach((h, i) => {
    running += (h.debit || 0) - (h.credit || 0);
    if (h.debit && running > 0) {
      const div = document.createElement("div");
      div.className = "outstanding-item";
      div.innerHTML = `<strong>Amount: ${h.debit}</strong><br>Remarks: ${h.remarks || ""}<br>Start: ${h.startDate || ""}, End: ${h.endDate || ""}`;
      div.onclick = () => {
        paymentRemarks.value = `Payment for: ${h.remarks || ""} (Amount: ${h.debit}, Start: ${h.startDate || ""}, End: ${h.endDate || ""})`;
        if (paymentMode.value === 'Partial') {
          paymentAmount.value = h.debit;
        }
      };
      outstandingList.appendChild(div);
    }
  });

  if (outstandingList.children.length === 0) {
    outstandingList.style.display = 'none';
  }
};

/* ---------- BOOKING ---------- */
bookingType.onchange = () => {
  singleDay.style.display = "none";
  multiDay.style.display = "none";
  if (bookingType.value === "single") singleDay.style.display = "block";
  if (bookingType.value === "multi") multiDay.style.display = "block";
};

/* ---------- ADD CHARGE ---------- */
addChargeBtn.onclick = async () => {
  const name = chargeName.value.trim();
  if (!name || !chargeAmount.value) return alert("Missing required fields");
  if (!bookingType.value) return alert("Please select a booking type");
  const clientId = cid(name);
  const originalAmount = Number(chargeAmount.value);
  const discount = Number(chargeDiscount.value) || 0;
  const amount = originalAmount - discount;  // Subtract discount from amount
  if (amount < 0) return alert("Discount cannot exceed the charge amount");
  const discountRemarksValue = discountRemarks.value;
  const remarks = chargeRemarks.value;
  let startDate = '', endDate = '';
  if (bookingType.value === 'single') {
    startDate = endDate = singleDate.value;
    if (!startDate) return alert("Please select a date for single day booking");
  } else if (bookingType.value === 'multi') {
    startDate = document.getElementById('startDate').value;
    endDate = document.getElementById('endDate').value;
    if (!startDate || !endDate) return alert("Please select start and end dates for multi day booking");
  }
  console.log('Start Date:', startDate, 'End Date:', endDate);  // Temporary debug log
  const historyEntry = {
    date: new Date().toISOString(),
    debit: amount,
    discount: discount,
    discountRemarks: discountRemarksValue,
    remarks,
    startDate,
    endDate
  };
  const clientRef = doc(db, "users", currentUser.uid, "clients", clientId);
  const clientSnap = await getDoc(clientRef);
  if (clientSnap.exists()) {
    const data = clientSnap.data();
    const newDebit = (data.debit || 0) + amount;
    const newHistory = [...(data.history || []), historyEntry];
    await updateDoc(clientRef, { debit: newDebit, history: newHistory });
  } else {
    await setDoc(clientRef, {
      name,
      debit: amount,
      credit: 0,
      history: [historyEntry]
    });
  }
  // Clear fields
  chargeName.value = '';
  bookingType.value = '';
  singleDate.value = '';
  document.getElementById('startDate').value = '';
  document.getElementById('endDate').value = '';
  chargeAmount.value = '';
  chargeDiscount.value = '';
  discountRemarks.value = '';
  chargeRemarks.value = '';
  singleDay.style.display = 'none';
  multiDay.style.display = 'none';
};

/* ---------- ADD PAYMENT ---------- */
addPaymentBtn.onclick = async () => {
  const name = paymentSearch.value.trim();
  if (!name || !paymentAmount.value) return;
  const clientId = cid(name);
  const amount = Number(paymentAmount.value);
  const adjustment = Number(paymentAdjustment.value) || 0;
  const totalCredit = amount + adjustment; // Assuming adjustment adds to credit (positive increases credit, negative decreases)
  const type = paymentType.value;
  const mode = paymentMode.value;
  const branch = paymentBranch.value;
  const remarks = paymentRemarks.value;
  const adjRemarks = adjustmentRemarks.value;
  const combinedRemarks = remarks + (adjRemarks ? ` (Adjustment: ${adjRemarks})` : '');
  const historyEntry = {
    date: new Date().toISOString(),
    credit: totalCredit,
    paymentType: type,
    branch,
    remarks: combinedRemarks,
    adjustment: adjustment // Store adjustment separately for tracking
  };
  const clientRef = doc(db, "users", currentUser.uid, "clients", clientId);
  const clientSnap = await getDoc(clientRef);
  if (clientSnap.exists()) {
    const data = clientSnap.data();
    const newCredit = (data.credit || 0) + totalCredit;
    const newHistory = [...(data.history || []), historyEntry];
    await updateDoc(clientRef, { credit: newCredit, history: newHistory });
  } else {
    await setDoc(clientRef, {
      name,
      debit: 0,
      credit: totalCredit,
      history: [historyEntry]
    });
  }
  // Fetch updated client data and re-populate remarks and outstanding
  const updatedClientSnap = await getDoc(clientRef);
  const updatedClient = updatedClientSnap.data();
  populateRemarksAuto(updatedClient);
  populateOutstanding(updatedClient);
  // Clear fields
  paymentSearch.value = '';
  paymentBalance.value = '';
  paymentAmount.value = '';
  paymentAdjustment.value = '';
  adjustmentRemarks.value = '';
  paymentType.value = 'Cash';
  paymentMode.value = 'Full';
  paymentBranch.value = '';
  paymentRemarks.value = '';
  outstandingList.style.display = 'none';
  outstandingList.innerHTML = '';
  remarksAuto.innerHTML = '';  // Clear remarks dropdown
  remarksAuto.style.display = 'none';  // Hide it
};

/* ---------- EXPENSES ---------- */
function loadExpenses() {
  onSnapshot(collection(db, "users", currentUser.uid, "expenses"), snap => {
    expenses = [];
    snap.forEach(d => expenses.push(d.data()));
  });
}

addExpenseBtn.onclick = async () => {
  if (!expenseDate.value || !expenseAmount.value) return;
  await addDoc(collection(db, "users", currentUser.uid, "expenses"), {
    date: expenseDate.value,
    amount: Number(expenseAmount.value),
    desc: expenseDesc.value
  });
  expenseDate.value = expenseAmount.value = expenseDesc.value = "";
};

window.viewExpenses = () => {
  if (!expStart.value || !expEnd.value) return;
  const s = new Date(expStart.value), e = new Date(expEnd.value);
  // Filter expenses within date range
  const filteredExpenses = expenses.filter(x => {
    const d = new Date(x.date);
    return d >= s && d <= e;
  });
  // Sort by date ascending
  filteredExpenses.sort((a, b) => new Date(a.date) - new Date(b.date));
  let total = 0;
  let html = "<table><tr><th>Date</th><th>Amount</th><th>Description</th></tr>";
  filteredExpenses.forEach(x => {
    total += x.amount;
    html += `<tr><td>${x.date}</td><td>${x.amount}</td><td>${x.desc}</td></tr>`;
  });
  html += `</table><p><b>Total Expenses:</b> ${total}</p>`;
  expenseResult.innerHTML = html;
};

saveNotesBtn.onclick = async () => {
  const adminRef = doc(db, "users", currentUser.uid, "settings", "admin");
  await setDoc(adminRef, { notes: adminNotes.value }, { merge: true });
  alert("Notes saved!");
};

  // NEW: Function to change admin code for current user
changeAdminCodeBtn.onclick = () => {
  const newCode = newAdminCode.value.trim();
  if (newCode) {
    const adminRef = doc(db, "users", currentUser.uid, "settings", "admin");
    setDoc(adminRef, { code: newCode }, { merge: true });
    window.currentAdminCode = newCode;
    alert("Admin code changed successfully!");
    newAdminCode.value = '';
  } else {
    alert("Please enter a valid code.");
  }
};

window.generateAdminReport = () => {
  if (!adminStart.value || !adminEnd.value) return alert("Select dates");
  const s = new Date(adminStart.value), e = new Date(adminEnd.value);
  let income = 0, exp = 0;
  let paymentSums = { "Cash": 0, "Bank Transfer": 0, "Credit Card": 0, "Others": 0 };

  Object.values(clients).forEach(c => {
    (c.history || []).forEach(h => {
      const d = new Date(h.date);
      if (d >= s && d <= e && h.credit) {
        income += h.credit;
        if (h.paymentType && paymentSums[h.paymentType] !== undefined) {
          paymentSums[h.paymentType] += h.credit;
        }
      }
    });
  });

  expenses.forEach(x => {
    const d = new Date(x.date);
    if (d >= s && d <= e) exp += x.amount;
  });

  let paymentSummary = "";
  Object.keys(paymentSums).forEach(type => {
    paymentSummary += `<p>Total ${type}: ${paymentSums[type]}</p>`;
  });

  adminResult.innerHTML = `
  <h4>Summary</h4>
  <p>Total Income: ${income}</p>
  ${paymentSummary}
  <p>Total Expenses: ${exp}</p>
  <p><b>Net:</b> ${income - exp}</p>`;
};
  
window.generateDailySalesReport = () => {
  if (!salesStart.value || !salesEnd.value) return alert("Select start and end dates");
  const s = new Date(salesStart.value), e = new Date(salesEnd.value);
  const selectedBranch = salesBranch.value;
  let totalSales = 0;
  let paymentTypeSales = { "Cash": 0, "Bank Transfer": 0, "Credit Card": 0, "Others": 0 };
  let branchSales = { "Main": 0, "Branch 1": 0, "Branch 2": 0 };

  Object.values(clients).forEach(c => {
    (c.history || []).forEach(h => {
      const d = new Date(h.date);
      if (d >= s && d <= e && h.credit) {
        const branch = h.branch || "Unknown";
        const paymentType = h.paymentType || "Others";
        // If a branch is selected, only include matching branch; otherwise, include all
        if (!selectedBranch || branch === selectedBranch) {
          totalSales += h.credit;
          if (paymentTypeSales[paymentType] !== undefined) {
            paymentTypeSales[paymentType] += h.credit;
          } else {
            paymentTypeSales["Others"] += h.credit;  // Fallback for unrecognized types
          }
          if (branchSales[branch] !== undefined) {
            branchSales[branch] += h.credit;
          }
        }
      }
    });
  });

  let html = `<h4>Sales Report (${salesStart.value} to ${salesEnd.value})</h4>`;
  if (selectedBranch) {
    html += `<p><strong>Filtered by Branch: ${selectedBranch}</strong></p>`;
  }

  // Summary by Payment Type
  html += `<h5>Summary by Payment Type</h5>`;
  Object.keys(paymentTypeSales).forEach(type => {
    html += `<p>${type}: ${paymentTypeSales[type]}</p>`;
  });
  html += `<p><strong>Total Sales: ${totalSales}</strong></p>`;

  // Breakdown by Branch
  html += `<h5>Breakdown by Branch</h5>`;
  Object.keys(branchSales).forEach(branch => {
    html += `<p>${branch}: ${branchSales[branch]}</p>`;
  });

  salesResult.innerHTML = html;
};
</script>
</body>
</html>














