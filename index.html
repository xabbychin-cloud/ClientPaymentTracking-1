<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Client Payment Tracker</title>
<style>
body{margin:0;font-family:Arial;background:#f4f4f4}
h1{background:#2e7d32;color:white;padding:15px;text-align:center;margin:0}
#toolbar{display:flex;gap:8px;padding:10px;background:#333;overflow-x:auto}
#toolbar button{background:#4CAF50;color:white;border:none;padding:10px 14px;border-radius:4px;cursor:pointer}
#toolbar button:hover{background:#43a047}
.section{display:none;background:white;margin:10px;padding:15px;border-radius:6px}
input,select,button{width:100%;padding:8px;margin-top:6px}
button{cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;text-align:left}
th{background:#eee;color:black}
.debit-red{color:red;font-weight:bold}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5)}
.modal-content{background:white;width:95%;max-width:900px;margin:5% auto;padding:15px;max-height:80vh;overflow:auto}
.close{float:right;font-size:22px;cursor:pointer}
.readonly{background:#eee}
.autocomplete-box{position:relative}
.autocomplete-list{position:absolute;background:white;border:1px solid #ccc;width:100%;max-height:150px;overflow:auto;z-index:100}
.autocomplete-item{padding:6px;cursor:pointer}
.autocomplete-item:hover{background:#f0f0f0}
#logoutBtn{background:#c62828;color:white;margin:15px}
.highlight { font-weight: bold; background-color: yellow; }
.balance-outstanding { color: red; font-weight: bold; }
.balance-paid { color: black; }
</style>
</head>
<body>

<h1>Client Payment Tracker</h1>

<div id="toolbar">
  <button onclick="showSection('clientSection')">Client Information</button>
  <button onclick="showSection('chargeSection')">Add Charge</button>
  <button onclick="showSection('paymentSection')">Add Payment</button>
  <button onclick="showSection('expenseSection')">Expenses</button>
  <button onclick="showSection('reportSection')">Admin Report</button>
</div>

<!-- LOGIN -->
<div id="authSection" class="section" style="display:block">
  <h3>Login</h3>
  <input id="loginEmail" placeholder="Email">
  <input id="loginPassword" type="password" placeholder="Password">
  <button id="loginBtn">Login</button>
</div>

<div id="appSection" style="display:none">

<!-- CLIENT INFORMATION -->
<div id="clientSection" class="section">
  <h3>Client Information</h3>
  <input id="clientSearchInput" placeholder="Search full name">
  <button id="clientSearchBtn">Search</button>
  <select id="clientFilter">
    <option value="all">All</option>
    <option value="outstanding">Outstanding</option>
    <option value="paid">Paid</option>
  </select>
  <table>
    <thead>
      <tr><th>Name</th><th>Debit</th><th>Credit</th><th>Balance</th><th>Status</th><th>Action</th></tr>
    </thead>
    <tbody id="clientsBody"></tbody>
  </table>
</div>

<!-- ADD CHARGE -->
<div id="chargeSection" class="section">
  <h3>Add Charge</h3>
  <div class="autocomplete-box">
    <input id="chargeName" placeholder="Client Full Name">
    <div id="chargeAuto" class="autocomplete-list"></div>
  </div>
  <input id="chargeAmount" type="number" placeholder="Amount">
  <input id="chargeStart" type="date">
  <input id="chargeEnd" type="date">
  <input id="chargeRemarks" placeholder="Remarks">
  <button id="addChargeBtn">Save Charge</button>
</div>

<!-- ADD PAYMENT -->
<div id="paymentSection" class="section">
  <h3>Add Payment</h3>
  <div class="autocomplete-box">
    <input id="paymentSearch" placeholder="Search Client">
    <div id="paymentAuto" class="autocomplete-list"></div>
  </div>
  <input id="paymentClientName" class="readonly" readonly>
  <input id="paymentBalance" class="readonly" readonly>
  <input id="paymentAmount" type="number" placeholder="Payment Amount">
  <select id="paymentType">
    <option value="">Payment Type</option>
    <option>Cash</option>
    <option>Bank Transfer</option>
    <option>Credit Card</option>
    <option>Others</option>
  </select>
  <select id="paymentMode">
    <option value="">Payment Mode</option>
    <option>Full</option>
    <option>Partial</option>
  </select>
  <input id="paymentDate" type="date">
  <input id="paymentRemarks" placeholder="Remarks">
  <button id="addPaymentBtn">Save Payment</button>
</div>

<!-- EXPENSE -->
<div id="expenseSection" class="section">
  <h3>Add Expense</h3>
  <input id="expenseStart" type="date" placeholder="Start Date">
  <input id="expenseEnd" type="date" placeholder="End Date">
  <input id="expenseAmount" type="number" placeholder="Amount">
  <input id="expenseDesc" placeholder="Description">
  <input id="expenseInvoice" placeholder="Invoice (optional)">
  <button id="addExpenseBtn">Save Expense</button>
</div>

<!-- REPORT -->
<div id="reportSection" class="section">
  <h3>Admin Report</h3>
  <input id="reportStart" type="date">
  <input id="reportEnd" type="date">
  <button id="generateReportBtn">Generate Report</button>
  <div id="reportResult"></div>
  <div id="expensesTable" style="display:none; margin-top: 15px;">
    <h4>Expenses List</h4>
    <table>
      <thead><tr><th>Date</th><th>Amount</th><th>Description</th><th>Invoice</th></tr></thead>
      <tbody id="expensesBody"></tbody>
    </table>
  </div>
</div>

<button id="logoutBtn">Logout</button>
</div>

<!-- VIEW MODAL -->
<div id="viewModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeViewModal()">&times;</span>
    <h3 id="viewTitle"></h3>
    <div id="viewSummary" style="margin-bottom: 15px; padding: 10px; background: #f9f9f9; border-radius: 4px;"></div>
    <table>
      <thead>
        <tr><th>Date</th><th>Debit</th><th>Credit</th><th>Method</th><th>Mode</th><th>Remarks</th><th>Start</th><th>End</th></tr>
      </thead>
      <tbody id="viewBody"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// ===== KEEP YOUR EXISTING FIREBASE CONFIG =====
const app = initializeApp({
  apiKey:"AIzaSyCrtGcFZVwP6dlsc_Bljr_yN-nu6hxihVg",
  authDomain:"client-payment-tracker-3572b.firebaseapp.com",
  projectId:"client-payment-tracker-3572b"
});

const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null, clients = {}, expenses = [];

const cid = n => n.toLowerCase().replace(/\s+/g, '_');
const formatDate = (isoString) => { if (!isoString) return ''; const d = new Date(isoString); return `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`; };
const highlightText = (text, query) => { if (!query) return text; const regex = new RegExp(`(${query})`, 'gi'); return text.replace(regex, '<span class="highlight">$1</span>'); };

// ===== LOGIN =====
loginBtn.onclick = () => { signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value).catch(e=>alert(e.message)); };

// ===== AUTH STATE =====
onAuthStateChanged(auth,u=>{
  if(u){ currentUser=u; authSection.style.display="none"; appSection.style.display="block"; loadClients(); loadExpenses(); }
  else{ currentUser=null; authSection.style.display="block"; appSection.style.display="none"; }
});

// ===== LOGOUT =====
logoutBtn.onclick = () => { signOut(auth).then(()=>{ alert("Logged out"); }).catch(e=>alert(e.message)); };

// ===== LOAD CLIENTS =====
function loadClients(){
  onSnapshot(collection(db,"users",currentUser.uid,"clients"),snap=>{
    clients={};
    snap.forEach(d=>clients[d.id]=d.data());
    renderClientTable();
  });
}

// ===== CLIENT TABLE =====
function renderClientTable(){
  const q = clientSearchInput.value.toLowerCase();
  const f = clientFilter.value;
  clientsBody.innerHTML="";
  let hasMatches=false;
  Object.values(clients).forEach(c=>{
    const bal=(c.debit||0)-(c.credit||0);
    const s=bal>0?"outstanding":"paid";
    if(q && !c.name.toLowerCase().includes(q)) return;
    if(f!=="all" && f!==s) return;
    hasMatches=true;
    const highlightedName = highlightText(c.name,q);
    clientsBody.innerHTML+=`<tr>
      <td>${highlightedName}</td>
      <td class="${bal>0?'debit-red':''}">${c.debit||0}</td>
      <td>${c.credit||0}</td>
      <td class="${bal>0?'debit-red':''}">${bal}</td>
      <td>${s}</td>
      <td><button onclick="viewClient('${c.name}')">View</button></td>
    </tr>`;
  });
  if(!hasMatches) clientsBody.innerHTML="<tr><td colspan='6' style='text-align:center;'>No records found matching your search and filter criteria.</td></tr>";
}
clientSearchBtn.onclick=renderClientTable;
clientFilter.onchange=renderClientTable;

// ===== AUTOCOMPLETE CHARGE =====
chargeName.oninput = ()=>{
  chargeAuto.innerHTML="";
  const q = chargeName.value.toLowerCase();
  Object.values(clients).forEach(c=>{
    if(c.name.toLowerCase().includes(q)){
      const d = document.createElement("div");
      d.className="autocomplete-item";
      d.textContent=c.name;
      d.onclick=()=>{ chargeName.value=c.name; chargeAuto.innerHTML=""; };
      chargeAuto.appendChild(d);
    }
  });
};

// ===== ADD CHARGE =====
addChargeBtn.onclick=async()=>{
  const name=chargeName.value;
  if(!name) return alert("Please enter a client name.");
  const ref=doc(db,"users",currentUser.uid,"clients",cid(name));
  const s=await getDoc(ref);
  const c=s.exists()?s.data():{name,debit:0,credit:0,history:[]};
  c.history.push({date:new Date().toISOString(),debit:+chargeAmount.value,credit:0,method:"charge",remarks:chargeRemarks.value,start:chargeStart.value,end:chargeEnd.value});
  await setDoc(ref,{name,debit:c.debit+ +chargeAmount.value,credit:c.credit,history:c.history});
  alert("Charge added");
  chargeName.value=""; chargeAmount.value=""; chargeStart.value=""; chargeEnd.value=""; chargeRemarks.value="";
};

// ===== VIEW CLIENT (FIXED: row highlighting only unpaid charges) =====
window.viewClient = (name)=>{
  const c = clients[cid(name)];
  if(!c){ alert("Client not found"); return; }

  viewTitle.textContent = name;
  viewBody.innerHTML="";
  let totalDebit=0, totalCredit=0;
  c.history.forEach(h=>{ totalDebit+=(h.debit||0); totalCredit+=(h.credit||0); });
  let remainingBalance = totalDebit - totalCredit;

  // SUMMARY
  viewSummary.innerHTML=`<strong>Total Add Charge:</strong> ${totalDebit}<br>
  <strong>Total Paid:</strong> ${totalCredit}<br>
  <strong>Balance:</strong> <span class="${remainingBalance>0?'balance-outstanding':'balance-paid'}">${remainingBalance}</span><br>
  <strong>Status:</strong> ${remainingBalance>0?'Outstanding':'Paid'}`;

  // HISTORY TABLE
  c.history.forEach(h=>{
    let highlight="";
    if(h.debit>0 && remainingBalance>0){
      highlight="debit-red";
      remainingBalance -= h.debit>remainingBalance?remainingBalance:h.debit;
    }
    viewBody.innerHTML+=`<tr>
      <td>${formatDate(h.date)}</td>
      <td class="${highlight}">${h.debit||0}</td>
      <td>${h.credit||0}</td>
      <td>${h.method||''}</td>
      <td>${h.mode||''}</td>
      <td>${h.remarks||''}</td>
      <td>${h.start||''}</td>
      <td>${h.end||''}</td>
    </tr>`;
  });
  viewModal.style.display="block";
};
window.closeViewModal=()=>viewModal.style.display="none";

// ===== AUTOCOMPLETE PAYMENT =====
paymentSearch.oninput=()=>{
  paymentAuto.innerHTML="";
  const q=paymentSearch.value.toLowerCase();
  Object.values(clients).forEach(c=>{
    if(c.name.toLowerCase().includes(q)){
      const d=document.createElement("div");
      d.className="autocomplete-item";
      d.textContent=c.name;
      d.onclick=()=>{ paymentClientName.value=c.name; const client=clients[cid(c.name)]; paymentBalance.value=client.debit-client.credit; paymentAuto.innerHTML=""; };
      paymentAuto.appendChild(d);
    }
  });
};

// ===== ADD PAYMENT (CLEAR FIELDS + LOCK OVERPAYMENT) =====
addPaymentBtn.onclick=async()=>{
  const name = paymentClientName.value;
  const amount = +paymentAmount.value;
  if(!name) return alert("Select a client first.");
  const ref = doc(db,"users",currentUser.uid,"clients",cid(name));
  const snap = await getDoc(ref);
  const client = snap.data();
  const balance = client.debit - client.credit;
  if(amount>balance) return alert("Payment exceeds balance. Overpayment is not allowed.");

  client.history.push({date:paymentDate.value,debit:0,credit:amount,method:"payment",mode:paymentMode.value,remarks:paymentRemarks.value});
  await setDoc(ref,{...client,credit:client.credit+amount});
  alert("Payment added");

  // CLEAR FIELDS
  paymentClientName.value=""; paymentBalance.value=""; paymentSearch.value="";
  paymentAmount.value=""; paymentType.value=""; paymentMode.value=""; paymentDate.value=""; paymentRemarks.value="";
};

// ===== EXPENSE =====
function loadExpenses(){
  onSnapshot(collection(db,"users",currentUser.uid,"expenses"),snap=>{
    expenses=[];
    snap.forEach(d=>expenses.push(d.data()));
  });
}
addExpenseBtn.onclick=async()=>{
  await addDoc(collection(db,"users",currentUser.uid,"expenses"),{
    date:expenseStart.value,
    amount:+expenseAmount.value,
    desc:expenseDesc.value,
    invoice:expenseInvoice.value
  });
  alert("Expense saved");
  expenseStart.value=""; expenseEnd.value=""; expenseAmount.value=""; expenseDesc.value=""; expenseInvoice.value="";
};

// ===== REPORT =====
generateReportBtn.onclick=()=>{
  const s=new Date(reportStart.value);
  const e=new Date(reportEnd.value);
  let sales=0;
  Object.values(clients).forEach(c=>c.history.forEach(h=>{ const d=new Date(h.date); if(h.credit&&d>=s&&d<=e) sales+=h.credit; }));
  const exp = expenses.filter(x=>new Date(x.date)>=s && new Date(x.date)<=e).reduce((a,b)=>a+b.amount,0);
  reportResult.innerHTML=`Sales: ${sales}<br>Expenses: ${exp}<br>Net: ${sales-exp}`;
  expensesTable.style.display="block"; // show expenses below report
  const filteredExpenses = expenses.filter(x=>new Date(x.date)>=s && new Date(x.date)<=e);
  expensesBody.innerHTML="";
  if(filteredExpenses.length===0) expensesBody.innerHTML="<tr><td colspan='4' style='text-align:center;'>No expenses found.</td></tr>";
  else filteredExpenses.forEach(exp=>{ expensesBody.innerHTML+=`<tr><td>${formatDate(exp.date)}</td><td>${exp.amount}</td><td>${exp.desc||''}</td><td>${exp.invoice||''}</td></tr>`; });
};

// ===== SHOW SECTION =====
window.showSection=id=>{ document.querySelectorAll(".section").forEach(s=>s.style.display="none"); document.getElementById(id).style.display="block"; };

</script>
</body>
</html>
