<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Payment Tracker</title>
    <style>
        body { margin: 0; font-family: Arial; background: #f4f6f9 }
        h1 { background: #2e7d32; color: white; padding: 15px; text-align: center; margin: 0 }
        #toolbar { display: flex; gap: 8px; padding: 10px; background: #333; overflow-x: auto }
        #toolbar button { background: #4CAF50; color: white; border: none; padding: 10px 14px; border-radius: 4px; cursor: pointer }
        #toolbar button.active { background: gold; color: black }
        .section { display: none; background: white; margin: 10px; padding: 15px; border-radius: 6px }
        input, select, button, textarea { width: 100%; padding: 8px; margin-top: 6px }
        table { width: 100%; border-collapse: collapse; margin-top: 10px }
        th, td { border: 1px solid #ccc; padding: 6px }
        th { background: #eee }
        .debit-red { color: red; font-weight: bold }
        .unpaid-row { background: #ffd6d6 }
        .autocomplete { position: relative }
        .autolist { position: absolute; background: white; border: 1px solid #ccc; width: 100%; z-index: 100 }
        .autolist div { padding: 6px; cursor: pointer }
        .autolist div:hover { background: #eee }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.5) }
        .modal-content { background: white; width: 95%; max-width: 900px; margin: 5% auto; padding: 15px }
        #logoutBtn { background: #c62828; color: white; margin: 15px }
        @media (max-width: 768px) {
            table, thead, tbody, th, td, tr { display: block }
            th { display: none }
            tr { margin-bottom: 10px }
            td { display: flex; justify-content: space-between }
        }
    </style>
</head>
<body>
    <h1>Client Payment Tracker</h1>
    <!-- LOGIN -->
    <div id="authSection" class="section" style="display:block">
        <input id="loginEmail" placeholder="Email">
        <input id="loginPassword" type="password" placeholder="Password">
        <button id="loginBtn">Login</button>
        <button id="signupBtn">Sign Up</button>
    </div>
    <!-- APP -->
    <div id="appSection" style="display:none">
        <div id="toolbar">
            <button onclick="showSection('dashboard')" class="active">Dashboard</button>
            <button onclick="showSection('clients')">Clients</button>
            <button onclick="showSection('charge')">Add Charge</button>
            <button onclick="showSection('payment')">Add Payment</button>
            <button onclick="showSection('expense')">Expenses</button>
            <button onclick="openAdmin()">Admin Report</button>
        </div>
        <!-- DASHBOARD -->
        <div id="dashboard" class="section" style="display:block">
            <h2>Dashboard</h2>
            <p>Income: <span id="dashIncome">0</span></p>
            <p>Expenses: <span id="dashExpense">0</span></p>
            <p>Net: <span id="dashNet">0</span></p>
        </div>
        <!-- CLIENTS -->
        <div id="clients" class="section">
            <select id="clientFilter">
                <option value="all">All</option>
                <option value="outstanding">Outstanding</option>
                <option value="paid">Paid</option>
            </select>
            <table>
                <thead><tr><th>Name</th><th>Debit</th><th>Credit</th><th>Balance</th><th>Action</th></tr></thead>
                <tbody id="clientsBody"></tbody>
            </table>
        </div>
        <!-- ADD CHARGE -->
        <div id="charge" class="section">
            <div class="autocomplete">
                <input id="chargeName" placeholder="Client Name">
                <div id="chargeAuto" class="autolist"></div>
            </div>
            <input id="chargeDate" type="date">
            <select id="bookingType">
                <option value="">Booking Type</option>
                <option value="single">Single Day</option>
                <option value="multi">Multi Day</option>
            </select>
            <div id="singleDay" style="display:none"><input id="singleDate" type="date"></div>
            <div id="multiDay" style="display:none">
                <input id="startDate" type="date">
                <input id="endDate" type="date">
            </div>
            <input id="chargeAmount" type="number" placeholder="Amount">
            <input id="chargeRemarks" placeholder="Remarks">
            <button id="addChargeBtn">Save Charge</button>
        </div>
        <!-- ADD PAYMENT -->
        <div id="payment" class="section">
            <div class="autocomplete">
                <input id="paymentSearch" placeholder="Client Name">
                <div id="paymentAuto" class="autolist"></div>
            </div>
            <input id="paymentDate" type="date">
            <input id="paymentBalance" readonly placeholder="Balance">
            <input id="paymentAmount" type="number" placeholder="Amount">
            <select id="paymentType">
                <option>Cash</option>
                <option>Bank Transfer</option>
                <option>Credit Card</option>
                <option>Others</option>
            </select>
            <select id="paymentMode">
                <option>Full</option>
                <option>Partial</option>
            </select>
            <input id="paymentRemarks" placeholder="Remarks">
            <button id="addPaymentBtn">Save Payment</button>
        </div>
        <!-- EXPENSE -->
        <div id="expense" class="section">
            <input id="expenseDate" type="date">
            <input id="expenseAmount" type="number" placeholder="Amount">
            <input id="expenseDesc" placeholder="Description">
            <button id="addExpenseBtn">Save Expense</button>
            <h3>View Expenses</h3>
            <input id="expStart" type="date">
            <input id="expEnd" type="date">
            <button onclick="viewExpenses()">Generate</button>
            <div id="expenseResult"></div>
        </div>
        <!-- ADMIN -->
        <div id="admin" class="section">
            <textarea id="adminNotes" placeholder="Notes"></textarea>
            <button onclick="saveNotes()">Save Note</button>
            <button id="viewAdminBtn">View Note</button>
            <div id="adminResult"></div>
        </div>
        <!-- VIEW MODAL -->
        <div id="viewModal" class="modal">
            <div class="modal-content">
                <button onclick="viewModal.style.display='none'">Close</button>
                <h3 id="viewTitle"></h3>
                <div id="viewSummary"></div>
                <table>
                    <thead><tr><th>Date</th><th>Debit</th><th>Credit</th><th>Remarks</th></tr></thead>
                    <tbody id="viewBody"></tbody>
                </table>
            </div>
        </div>
        <button id="logoutBtn">Logout</button>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const ADMIN_CODE = "1234";
        const app = initializeApp({
            apiKey: "AIzaSyCrtGcFZVwP6dlsc_Bljr_yN-nu6hxihVg",
            authDomain: "client-payment-tracker-3572b.firebaseapp.com",
            projectId: "client-payment-tracker-3572b"
        });
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser, clients = {}, expenses = [];
        const cid = n => n.toLowerCase().replace(/\s+/g, '_');

        /* ==================== AUTH ==================== */
        loginBtn.onclick = () => {
            const email = loginEmail.value.trim(), password = loginPassword.value;
            if (!email || !password) { alert("Enter email and password"); return; }
            signInWithEmailAndPassword(auth, email, password)
                .then(u => { console.log("Logged in", u.user.email); loginEmail.value = ""; loginPassword.value = ""; })
                .catch(e => { console.error(e); alert("Login failed: " + e.message); });
        };
        signupBtn.onclick = () => {
            const email = loginEmail.value.trim(), password = loginPassword.value;
            if (!email || !password) { alert("Enter email and password"); return; }
            createUserWithEmailAndPassword(auth, email, password)
                .then(u => { alert("Signup successful!"); loginEmail.value = ""; loginPassword.value = ""; })
                .catch(e => { console.error(e); alert("Signup failed: " + e.message); });
        };
        logoutBtn.onclick = () => {
            signOut(auth).then(() => console.log("Logged out")).catch(console.error);
        };
        onAuthStateChanged(auth, u => {
            if (u) {
                currentUser = u;
                authSection.style.display = "none";
                appSection.style.display = "block";
                loadClients();
                loadExpenses();
            } else {
                authSection.style.display = "block";
                appSection.style.display = "none";
            }
        });

        /* ==================== CLIENTS ==================== */
        function loadClients() {
            onSnapshot(collection(db, "users", currentUser.uid, "clients"), snap => {
                clients = {};
                snap.forEach(d => clients[d.id] = d.data());
                renderClients();
                updateClientAuto();
                updateDashboard();
            });
        }
        // Add this after the select in HTML (or in script):
clientFilter.onchange = () => renderClients();

// Modify renderClients():
function renderClients() {
    clientsBody.innerHTML = "";
    const filter = clientFilter.value;
    Object.values(clients).forEach(c => {
        const bal = (c.debit || 0) - (c.credit || 0);
        const show = filter === "all" || 
                     (filter === "outstanding" && bal > 0) || 
                     (filter === "paid" && bal <= 0);
        if (show) {
            clientsBody.innerHTML += `<tr>
                <td>${c.name}</td>
                <td>${c.debit || 0}</td>
                <td>${c.credit || 0}</td>
                <td class="${bal > 0 ? 'debit-red' : ''}">${bal}</td>
                <td><button onclick="viewClient('${c.name}')">View</button></td>
            </tr>`;
        }
    });
}
        /* ==================== VIEW CLIENT ==================== */
       window.viewClient = name => {
    const c = clients[cid(name)];
    if (!c) return;
    let runningBalance = 0;
    viewBody.innerHTML = "";
    (c.history || []).sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(h => {
        runningBalance += (h.debit || 0) - (h.credit || 0);
        viewBody.innerHTML += `<tr class="${runningBalance > 0 ? 'unpaid-row' : ''}">
            <td>${new Date(h.date).toLocaleString()}</td>
            <td>${h.debit || 0}</td>
            <td>${h.credit || 0}</td>
            <td>${h.remarks || ''}</td>
        </tr>`;
    });
    // Update summary as before
};

        /* ==================== ADD CHARGE ==================== */
        bookingType.onchange = () => {
            singleDay.style.display = bookingType.value === "single" ? "block" : "none";
            multiDay.style.display = bookingType.value === "multi" ? "block" : "none";
        };
        addChargeBtn.onclick = async () => {
            if (!confirm(`Add charge of ${chargeAmount.value} to ${chargeName.value}?`)) return;
            const ref = doc(db, "users", currentUser.uid, "clients", cid(chargeName.value));
            const s = await getDoc(ref);
            const c = s.exists() ? s.data() : { name: chargeName.value, debit: 0, credit: 0, history: [] };
            c.history.push({ date: chargeDate.value, debit: +chargeAmount.value, remarks: chargeRemarks.value });
            await setDoc(ref, { ...c, debit: c.debit + +chargeAmount.value });
        };

        /* ==================== ADD PAYMENT ==================== */
       addPaymentBtn.onclick = async () => {
    // ... existing code ...
    const c = s.data();
    const balance = (c.debit || 0) - (c.credit || 0);
    let amount = +paymentAmount.value;
    if (paymentMode.value === "partial" && amount > balance) {
        alert("Partial payment cannot exceed balance.");
        return;
    }
    // ... proceed ...
};

        /* ==================== EXPENSE ==================== */
        function loadExpenses() {
            onSnapshot(collection(db, "users", currentUser.uid, "expenses"), snap => {
                expenses = [];
                snap.forEach(d => expenses.push(d.data()));
                updateDashboard();
            });
        }
        addExpenseBtn.onclick = () => {
            if (!confirm(`Add expense of ${expenseAmount.value}?`)) return;
            addDoc(collection(db, "users", currentUser.uid, "expenses"), { date: expenseDate.value, amount: +expenseAmount.value, desc: expenseDesc.value });
        };
        window.viewExpenses = () => {
            const s = new Date(expStart.value), e = new Date(expEnd.value);
            let t = 0, html = "<table><tr><th>Date</th><th>Amount</th><th>Description</th></tr>";
            expenses.forEach(x => {
                const d = new Date(x.date);
                if (d >= s && d <= e) {
                    t += x.amount;
                    html += `<tr><td>${d.toLocaleDateString()}</td><td>${x.amount}</td><td>${x.desc}</td></tr>`;
                  window.viewExpenses = () => {
    if (!expStart.value || !expEnd.value) { alert("Select start and end dates."); return; }
    // ... rest ...
};
                }
            });
            expenseResult.innerHTML = html + "</table>Total:" + t;
        };

        /* ==================== DASHBOARD UPDATE ==================== */
        function updateDashboard() {
            let inc = 0, exp = 0;
            Object.values(clients).forEach(c => (c.history || []).forEach(h => { if (h.credit) inc += h.credit; }));
            expenses.forEach(e => { exp += e.amount; });
            dashIncome.textContent = inc;
            dashExpense.textContent = exp;
            dashNet.textContent = inc - exp;
        }

        /* ==================== ADMIN ==================== */
        window.openAdmin = () => {
            if (prompt("Admin code") === ADMIN_CODE) {
                showSection("admin");
                document.querySelector("#toolbar button[onclick='openAdmin()']").classList.add("active");
            } else {
                alert("Access denied");
            }
        };
        window.saveNotes = async () => {
            await setDoc(doc(db, "users", currentUser.uid), { notes: adminNotes.value }, { merge: true });
        };
        viewAdminBtn.onclick = async () => {
            const docSnap = await getDoc(doc(db, "users", currentUser.uid));
            if (docSnap.exists() && docSnap.data().notes) alert("Notes:\n" + docSnap.data().notes);
            else alert("No notes found.");
        };

        /* ==================== TOOLBAR & SECTIONS ==================== */
        window.showSection = id => {
            document.querySelectorAll(".section").forEach(s => s.style.display = "none");
            const sec = document.getElementById(id);
            if (sec) sec.style.display = "block";
            document.querySelectorAll("#toolbar button").forEach(btn => btn.classList.remove("active"));
            const activeBtn = Array.from(document.querySelectorAll("#toolbar button"))
                .find(btn => btn.textContent.toLowerCase() === id.toLowerCase());
            if (activeBtn) activeBtn.classList.add("active");
        };

        /* ==================== AUTOCOMPLETE ==================== */
        function updateClientAuto() {
            const clientNames = Object.values(clients).map(c => c.name);
            chargeName.oninput = () => {
                chargeAuto.innerHTML = "";
                const val = chargeName.value.toLowerCase();
                clientNames.filter(n => n.toLowerCase().includes(val)).forEach(n => {
                    const div = document.createElement("div");
                    div.textContent = n;
                    div.onclick = () => { chargeName.value = n; chargeAuto.innerHTML = ""; };
                    chargeAuto.appendChild(div);
                });
            };
            paymentSearch.oninput = () => {
                paymentAuto.innerHTML = "";
                const val = paymentSearch.value.toLowerCase();
                clientNames.filter(n => n.toLowerCase().includes(val)).forEach(n => {
                    const div = document.createElement("div");
                    div.textContent = n;
                    div.onclick = () => {
                        paymentSearch.value = n;
                        paymentAuto.innerHTML = "";
                        const c = clients[cid(n)];
                        if (c) paymentBalance.value = (c.debit || 0) - (c.credit || 0);
                    };
                    paymentAuto.appendChild(div);
                });
            };
        }
    </script>
</body>
</html>
